<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Performance - 标签 - 谷中仁的博客</title><link>https://guzhongren.github.io/tags/performance/</link><description>Performance - 标签 - 谷中仁的博客</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><copyright>Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Sat, 16 Apr 2022 14:11:32 +0800</lastBuildDate><atom:link href="https://guzhongren.github.io/tags/performance/" rel="self" type="application/rss+xml"/><item><title>Continuously Optimize Your Website With Lighthouse CI</title><link>https://guzhongren.github.io/2022/04/continuously-optimize-your-website-with-lighthouse-ci/</link><pubDate>Sat, 16 Apr 2022 14:11:32 +0800</pubDate><author>谷中仁</author><guid>https://guzhongren.github.io/2022/04/continuously-optimize-your-website-with-lighthouse-ci/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://cdn.staticaly.com/gh/guzhongren/data-hosting@main/Tools/Lighthouse/Lighthouse-Chrome-DevTools.47rhl099s9c0.webp" referrerpolicy="no-referrer">
            </div><blockquote>
<p>Performance has directly impacted the company&rsquo;s bottom line.
&ndash; <a href="https://www.youtube.com/watch?v=Xryhxi45Q5M&amp;feature=youtu.be&amp;t=1366" target="_blank" rel="noopener noreffer ">Pinterest</a></p>
</blockquote>
<h2 id="intro">Intro</h2>
<p>Since the development of the Internet, web page performance has always been an important issue. All major Internet companies are sparing no effort to optimize their web pages, in order to allow users to see the content that users want to see faster.</p>
<p>During the development of the Internet in recent decades, various indicators and terms for measuring web performance have stabilized, and the measurement methods of various products have tended to be consistent.</p>
<p>The BBC found that every 1 second increase in the load time of its website was associated with losing 10% more users.
DoubleClick by Google found that 53% of mobile site visits are abandoned if a page takes longer than 3 seconds to load.
DoubleClick by Google research shows that sites with loading times under 5 seconds experience 70% longer sessions, 35% lower bounce rates, and 25% higher ad viewability rates than sites that load about four times as long (19 seconds).
Mobify saw a 1.11% increase in session-based conversions for every 100 milliseconds decrease in homepage load time and an average annual revenue increase of nearly $380,000.
AutoAnything saw a 12-13% increase in sales after halving its page load time.
It can be seen how important the performance of web pages is in today&rsquo;s Internet of Everything era.</p>
<h2 id="problems-with-measuring-web-performance">Problems with measuring web performance</h2>
<h3 id="not-runnable-natively-to-catch-performance-issues-as-early-as-possible">Not runnable natively to catch performance issues as early as possible</h3>
<p>Many tools cannot be run locally; if the web performance testing tools can be run locally, developers can find problems earlier and solve them locally as soon as possible, avoiding running on CI for a while before finding problems , which can save a lot of time and improve production efficiency in the agile development process of <code>CI/CD</code>. <code>Shift-left of the web performance test</code> is bound to bring more benefits to the performance of web products, and even more profits for the company.</p>
<h3 id="inability-to-continuously-measure-performance-metrics">Inability to continuously measure performance metrics</h3>
<p>At present, most of the web performance measurement products on the market are <code>Sass</code> products. Using its products, we can only get a visual result page after running the performance test, but it cannot continuously record the improvement records of web page performance, and cannot be well quantified the life cycle of a web product performance. Of course there are also web performance testing tools that implement history, such as <a href="https://treo.sh/" target="_blank" rel="noopener noreffer ">treo</a>.</p>
<h3 id="cost">Cost</h3>
<p>There are many open source free web performance testing tools, but they may not be so easy to use; if you need more features, such as continuous recording of web page performance, generally only commercial products will support it, and the fees are not low.</p>
<h3 id="difficulty-with-ci-integration">Difficulty with CI integration</h3>
<p>As mentioned earlier, many tools either cannot be run locally or are Sass products, which cannot be well integrated with Pipeline, resulting in long feedback cycles of web performance results and make the engineering efficiency too low.</p>
<h2 id="lighthouse">Lighthouse</h2>
<blockquote>
<p>Lighthouse is an open-source, automated tool for improving the quality of web pages. You can run it against any web page, public or requiring authentication. It has audits for performance, accessibility, progressive web apps, SEO and more.</p>
</blockquote>
<blockquote>
<p>You can run Lighthouse in <code>Chrome DevTools</code>, from the command line, or as a <code>Node</code> module. You give <code>Lighthouse</code> a URL to audit, it runs a series of audits against the page, and then it generates a report on how well the page did. From there, use the failing audits as indicators on how to improve the page. Each audit has a reference doc explaining why the audit is important, as well as how to fix it.</p>
</blockquote>
<blockquote>
<p>You can also use Lighthouse CI to prevent regressions on your sites.</p>
</blockquote>
<p>It&rsquo;s very easy to use, take a look at the results of my audit of my open source project <a href="https://github.com/guzhongren/Powerboard" target="_blank" rel="noopener noreffer ">Powerboard</a>.
</p>
<h2 id="ways-of-lighthouse-ci-and-lighthouse-server">Ways of Lighthouse CI and Lighthouse Server</h2>
<h3 id="lighthouse-ci-lhci">Lighthouse CI （LHCI）</h3>
<blockquote>
<p>Automate running Lighthouse for every commit, viewing the changes, and preventing regressions
&ndash; <a href="https://github.com/GoogleChrome/lighthouse-ci" target="_blank" rel="noopener noreffer ">GoogleChrome/lighthouse-ci</a></p>
</blockquote>
<p><code>Lighthouse CI</code> is a suite of tools that make continuously running, saving, retrieving, and asserting against Lighthouse results as easy as possible.</p>
<h4 id="how-to-use">How to use</h4>
<p><code>LHCI</code> provides the <code>npm</code> installation package, which can be well integrated on the Pipeline, just run the <code>autorun</code> command in the corresponding directory, the command is as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">npm install -g @lhci/cli
</span></span><span class="line"><span class="cl">lhci autorun
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the operation is completed, LHCI will store the results in the <code>.lighthouseci</code> directory, and you can open the corresponding report with a browser.</p>
<h3 id="lighthouse-server">Lighthouse Server</h3>
<blockquote>
<p>The LHCI server saves historical Lighthouse data, displays trends in a dashboard, and offers an in-depth build comparison UI to uncover differences between builds.</p>
</blockquote>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<h4 id="installation-and-use-of-lhci-server">Installation and use of LHCI Server</h4>
<p>There are many ways to install LHCI Server, please refer to <a href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/server.md#lhci-server" target="_blank" rel="noopener noreffer ">here</a>, the recommended way is to use Docker. Note that the first run needs to create a Lighthouse App, you need to run the <code>lhci wizard</code> in the container and fill in the corresponding information, <strong>finally record the generated <code>Build token</code> and <code>Admin token</code></strong>.</p>
<h3 id="integration-with-lighthouse-ci-and-lighthouse-server">Integration with Lighthouse CI and Lighthouse Server</h3>
<p></p>
<ul>
<li>We have already talked about how to install <code>lhci</code> and <code>lhci server</code>, the next step is to use the two together. Here we take <code>GitHub Actions</code> as an example to make a demo.</li>
<li>Build <code>GitHub workflow</code>. For specific practices, please refer to the implementation details of <a href="https://github.com/guzhongren/Powerboard" target="_blank" rel="noopener noreffer ">Powerboard</a></li>
<li>.github/workflows/Lighthouse.yml</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Lighthouse CI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lhci</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Lighthouse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ref</span><span class="p">:</span><span class="w"> </span><span class="l">${{ github.event.pull_request.head.sha }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Use Node.js 10.x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/setup-node@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">node-version</span><span class="p">:</span><span class="w"> </span><span class="m">16.14.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">npm install, build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm install
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm run build</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Upload Lighthouse Report</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm install -g @lhci/cli
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci autorun --config=.github/config/lighthouserc-no-condition.json
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci upload --serverBaseUrl=${{ secrets.LHCI_SERVER_URL }} --token=${{ secrets.LHCI_BUILD_TOKEN }}</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">LHCI_GITHUB_APP_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.LHCI_GITHUB_APP_TOKEN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Check Lighthouse Report</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci autorun --config=.github/config/lighthouserc.json</span><span class="w">          
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>.github/config/lighthouserc-no-condition.json</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ci&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;collect&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;staticDistDir&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formFactor&#34;</span><span class="p">:</span> <span class="s2">&#34;desktop&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;screenEmulation&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mobile&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;width&#34;</span><span class="p">:</span> <span class="mi">1920</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;deviceScaleFactor&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;disabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;assert&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;assertions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:performance&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:accessibility&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:best-practices&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:seo&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:pwa&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>.github/config/lighthouserc.json</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ci&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;collect&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;staticDistDir&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formFactor&#34;</span><span class="p">:</span> <span class="s2">&#34;desktop&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;screenEmulation&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mobile&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;width&#34;</span><span class="p">:</span> <span class="mi">1920</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;deviceScaleFactor&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;disabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;assert&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;assertions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:performance&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.8</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:accessibility&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.95</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:best-practices&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:seo&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:pwa&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;warn&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.99</span> <span class="p">}]</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Need to store the <code>Build token</code> generated by <code>lhci Server</code> and the address of <code>lhci Server</code> in the Secrets of the GitHub project</li>
<li>Here the <code>lhci</code> command is executed twice. Because <code>lhci autorun</code> runs the default <code>assertion</code>, the first time you use the command without assertion, the purpose is to upload the current web page performance to the server side; the second time you configure various indicators Threshold, if it does not meet the requirements, Pipeline will block, to achieve <code>Shift-left of the web performance test</code>.</li>
<li></li>
</ul>
<h2 id="summary">Summary</h2>
<ul>
<li>For: Developers, technical leads or marketers</li>
<li>They want to: <code>continuously quantify</code> and demonstrate the <code>performance</code> of web pages</li>
<li>This: Lighthouse CI</li>
<li>is one: a set of tools written by <code>Google</code> to make it as easy as possible to continuously run, save, retrieve, and assert on <code>Lighthouse</code> results. It can evaluate web applications and pages, as well as gather information such as performance metrics and insights from development best practices</li>
<li>It can: test your web page, get web page&rsquo;s <code>Performance</code> , <code>Accessibility</code> , <code>Best Practices</code> , <code>SEO</code> and <code>PWA</code> scores on different <code>devices</code>, these scores can be used to analyze the product performance, helping to improve user conversion rates, etc.</li>
<li>Unlike: <a href="https://treo.sh/" target="_blank" rel="noopener noreffer ">treo</a> or some other web performance testing tool</li>
<li>Its advantages are: <code>Open-Source</code>, <code>Free</code>, <code>Self-hosted</code> data and Server, <code>Easy to integrate</code>.</li>
</ul>
<h2 id="引用">引用</h2>
<ul>
<li><a href="https://web.dev/i18n/zh/why-speed-matters/" target="_blank" rel="noopener noreffer ">Get Down to Business: Why the web Matters (Chrome Dev Summit 2018): https://web.dev/i18n/zh/why-speed-matters/</a></li>
<li><a href="https://web.dev/i18n/zh/why-speed-matters" target="_blank" rel="noopener noreffer ">why Speed Matters？: https://web.dev/i18n/zh/why-speed-matters</a></li>
<li><a href="https://developers.google.cn/web/tools/lighthouse" target="_blank" rel="noopener noreffer ">Lighthouse: https://developers.google.cn/web/tools/lighthouse</a></li>
<li><a href="https://www.webpagetest.org/" target="_blank" rel="noopener noreffer ">WebPageTest: https://www.webpagetest.org/</a></li>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">博客:https://guzhongren.github.io/</a></li>
</ul>
<h2 id="免责声明">免责声明</h2>
<p>本文仅代表个人观点，与本人所供职的公司无任何关系。</p>
<hr>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: f2fe1394e4ab9297ed69ff73ac32e9ac1375f01c2102183b509bf9379a5995d6</p>
</blockquote>
<h2 id="赞助">赞助</h2>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: 964978ecd2059064abe542e51dc02e204d3ee2e6c320ca68e2b1399ce0c6953c</p>
</blockquote>
<blockquote>
<p>使用此<a href="https://guzhongren.github.io/images/pay/payforguzhongren.svg.sig" target="_blank" rel="noopener noreffer ">文件</a>进行校验： <code>gpg --verify PayForGuzhongren.svg.sig</code></p>
</blockquote>
]]></description></item><item><title>使用 Lighthouse 持续优化你的 Web 性能</title><link>https://guzhongren.github.io/2022/03/%E4%BD%BF%E7%94%A8-lighthouse-%E6%8C%81%E7%BB%AD%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84-web-%E6%80%A7%E8%83%BD/</link><pubDate>Sun, 27 Mar 2022 14:27:12 +0800</pubDate><author>谷中仁</author><guid>https://guzhongren.github.io/2022/03/%E4%BD%BF%E7%94%A8-lighthouse-%E6%8C%81%E7%BB%AD%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84-web-%E6%80%A7%E8%83%BD/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://cdn.staticaly.com/gh/guzhongren/data-hosting@main/Tools/Lighthouse/Lighthouse-Chrome-DevTools.47rhl099s9c0.webp" referrerpolicy="no-referrer">
            </div><blockquote>
<p>性能是留住用户的关键，
性能直接影响公司的命运。
&ndash; <a href="https://www.youtube.com/watch?v=Xryhxi45Q5M&amp;feature=youtu.be&amp;t=1366" target="_blank" rel="noopener noreffer ">Pinterest</a></p>
</blockquote>
<h2 id="介绍">介绍</h2>
<p>互联网发展至今，网页性能始终是一个重要的问题, 各大互联网公司都在不遗余力的优化自己的 Web 页面，为的就是更快的让用户更快的看到用户想看到的内容。</p>
<p>互联网在近几十年的发展过程中，度量 Web 性能各个指标、术语已经稳定了，各个产品的度量方式都趋于一致。</p>
<p>BBC 发现其网站的加载时间每增加 1 秒，便会多失去 10% 的用户。
DoubleClick by Google 发现，如果页面加载时间超过 3 秒，53% 的移动网站访问活动将遭到抛弃。
DoubleClick by Google 研究表明，与加载时间约为四倍（19 秒）的网站相比，加载时间在 5 秒以内的网站会话加长 70%、跳出率下降 35%、广告可见率上升 25%。
Mobify 的首页加载时间每减少 100 毫秒，基于会话的转化率增加 1.11%，年均收入增长近 380,000 美元。
AutoAnything 的页面加载时间减少一半后，其销售额提升 12-13%。
可见，Web 页面的性能在现今万物互联的时代有多重要。</p>
<h2 id="web-性能在度量方面存在的问题">Web 性能在度量方面存在的问题</h2>
<h3 id="不可本地运行以尽可能早地发现性能问题">不可本地运行，以尽可能早地发现性能问题</h3>
<p>很多工具都不可以在本地运行； 如果 Web 性能测试工具可以在本地运行，开发人员可以更早地发现问题，并尽可能早的在本地解决，避免了在 CI 上跑了一会了才发现问题，在 <code>CI/CD</code> 的敏捷开发过程中这样可以节省很多时间，提高生产效率。<code>Web 性能测试左移</code> 必定为 Web 产品性能带来更多好处，甚至为公司带来更多盈利。</p>
<h3 id="不能持续度量性能指标">不能持续度量性能指标</h3>
<p>目前市场上 Web 性能度量的产品大多都是 <code>Sass</code> 产品，使用其产品我们只能得到一个运行完性能测试的可视化结果页面，但是不能持续的记录 Web 网页性能的改进记录，不能很好的量化一个 Web 产品性能的生命周期。当然也有实现历史记录的 Web 性能测试工具，例如 <a href="https://treo.sh/" target="_blank" rel="noopener noreffer ">treo</a>。</p>
<h3 id="费用">费用</h3>
<p>开源免费的 Web 性能测试工具有不少，但是用起来可能没有那么爽；如果需要更多的特性，如持续记录 Web 网页性能，一般只有商业产品会支持，而且收费还不低。</p>
<h3 id="ci-集成困难">CI 集成困难</h3>
<p>如前面所说，很多工具要么是本地不能运行，要么就是 Sass 产品，不能很好的与 Pipeline 集成， 导致 Web 性能结果反馈周期长、工程效率低等问题。</p>
<h2 id="lighthouse">Lighthouse</h2>
<blockquote>
<p>Lighthouse 是一个开源的、自动化的工具，用以提高网页质量。你可以在任何网页上运行它，公开的或需要认证的。它对性能、可访问性、渐进式web应用程序、SEO 等进行审计。
你可以在 <code>Chrome DevTools</code>、 命令行甚至是 <code>Node</code> 模块中运行 <code>Lighthouse</code>。 向 Lighthouse 提供一个要审计的 URL，它会对页面运行一系列审计，随即会生成一个关于页面运行情况的报告。对于失败的审计项，可以使用对应项的改进方案。每个审计项都有一个参考文档，解释为什么审核很重要，以及如何修复它。</p>
</blockquote>
<p>使用方法非常简单，可以看一下我对我的开源项目 <code>Powerboard</code> 审计的结果。
</p>
<h2 id="lighthouse-ci-及-lighthouse-server-的使用">Lighthouse CI 及 Lighthouse Server 的使用</h2>
<h3 id="lighthouse-ci-lhci">Lighthouse CI （LHCI）</h3>
<blockquote>
<p>Automate running Lighthouse for every commit, viewing the changes, and preventing regressions
为每个提交自动化运行Lighthouse，查看更改，并防止回归
&ndash; <a href="https://github.com/GoogleChrome/lighthouse-ci" target="_blank" rel="noopener noreffer ">GoogleChrome/lighthouse-ci</a></p>
</blockquote>
<p><code>Lighthouse CI</code> 是 <code>Google Chrome</code> 团队开发的一套可以让持续运行、保存、检索和对 Lighthouse 结果进行<code>断言</code>变得尽可能简单的工具,可以很方便的集成在 CI 上。</p>
<h4 id="使用">使用</h4>
<p><code>LHCI</code> 提供 <code>npm</code> 安装包，可以很好的在 Pipeline 上集成，只需要在对应目录下运行 <code>autorun</code> 命令即可，命令如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">npm install -g @lhci/cli
</span></span><span class="line"><span class="cl">lhci autorun
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行完成后，LHCI 会将结果存放在 <code>.lighthouseci</code> 目录下，用浏览器打开对应的报告即可。</p>
<h3 id="lighthouse-server">Lighthouse Server</h3>
<blockquote>
<p>The LHCI server saves historical Lighthouse data, displays trends in a dashboard, and offers an in-depth build comparison UI to uncover differences between builds.
LHCI Server 保存 Lighthouse 历史数据，并可在仪表板中显示趋势，并提供深入的构建比较 UI，以揭示构建之间的差异。</p>
</blockquote>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<h4 id="lhci-server-的安装和使用">LHCI Server 的安装和使用</h4>
<p>LHCI Server 的安装有多种方式，具体可参考<a href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/server.md#lhci-server" target="_blank" rel="noopener noreffer ">这里</a>，推荐使用 Docker 的方式运行。需要注意的是，第一次运行需要创建 Lighthouse App, 需要在容器中运行 <code>lhci wizard</code> 并填入相应的信息，<strong>最后记录下生成的 <code>Build token</code> 和 <code>Admin token</code></strong>。</p>
<h3 id="lighthouse-ci-和-lighthouse-server-集成">Lighthouse CI 和 Lighthouse Server 集成</h3>
<p></p>
<ul>
<li>前面已经讲了 <code>lhci</code> 和 <code>lhci server</code> 如何安装了，接下来就是需要将两者结合起来一起使用了。这里我们以 <code>GitHub Actions</code> 为例来搞一个 Demo。</li>
<li>构建 <code>GitHub workflow</code>， 具体实践可参考 <a href="https://github.com/guzhongren/Powerboard" target="_blank" rel="noopener noreffer ">Powerboard</a> 的实现细节</li>
<li>.github/workflows/Lighthouse.yml</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Lighthouse CI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lhci</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Lighthouse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ref</span><span class="p">:</span><span class="w"> </span><span class="l">${{ github.event.pull_request.head.sha }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Use Node.js 10.x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/setup-node@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">node-version</span><span class="p">:</span><span class="w"> </span><span class="m">16.14.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">npm install, build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm install
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm run build</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Upload Lighthouse Report</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          npm install -g @lhci/cli
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci autorun --config=.github/config/lighthouserc-no-condition.json
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci upload --serverBaseUrl=${{ secrets.LHCI_SERVER_URL }} --token=${{ secrets.LHCI_BUILD_TOKEN }}</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">LHCI_GITHUB_APP_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.LHCI_GITHUB_APP_TOKEN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Check Lighthouse Report</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          lhci autorun --config=.github/config/lighthouserc.json</span><span class="w">          
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>.github/config/lighthouserc-no-condition.json</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ci&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;collect&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;staticDistDir&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formFactor&#34;</span><span class="p">:</span> <span class="s2">&#34;desktop&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;screenEmulation&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mobile&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;width&#34;</span><span class="p">:</span> <span class="mi">1920</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;deviceScaleFactor&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;disabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;assert&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;assertions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:performance&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:accessibility&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:best-practices&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:seo&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:pwa&#34;</span><span class="p">:</span> <span class="s2">&#34;off&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>.github/config/lighthouserc.json</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ci&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;collect&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;staticDistDir&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formFactor&#34;</span><span class="p">:</span> <span class="s2">&#34;desktop&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;screenEmulation&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mobile&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;width&#34;</span><span class="p">:</span> <span class="mi">1920</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;deviceScaleFactor&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;disabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;assert&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;assertions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:performance&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.8</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:accessibility&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.95</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:best-practices&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:seo&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;categories:pwa&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;warn&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&#34;minScore&#34;</span><span class="p">:</span> <span class="mf">0.99</span> <span class="p">}]</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>需要将 <code>lhci Server</code> 生成的 <code>Build token</code> 和 <code>lhci Server</code> 的地址存放在 GitHub 项目的 Secrets 中</li>
<li>这里执行了两次 <code>lhci</code> 命令。因为 <code>lhci autorun</code> 运行完成后会运行默认的断言(<code>Assertion</code>), 第一次用没有断言的命令，目的是将当前的网页性能可以上到 Server 端; 第二次配置了各项指标的阈值，如果不满足要求，Pipeline 将会阻断，实现 <code>Web 性能测试左移</code>。</li>
<li></li>
</ul>
<h2 id="总结">总结</h2>
<ul>
<li>对于：开发人员、技术领导或者市场营销人员</li>
<li>他们想：<code>持续量化</code>并展示 Web 页面的<code>性能</code></li>
<li>这个：Lighthouse CI</li>
<li>是一个：由 <code>Google</code> 编写的一套工具，可以持续运行、保存、检索并对 <code>Lighthouse</code> 结果进行断言变得尽可能简单。它可以评估 Web 应用和页面，以及从开发的最佳实践中收集性能指标和洞见等信息</li>
<li>它可以：测试你的 Web 页面，得到 Web 页面的 <code>Performance</code> 、 <code>Accessibility</code> 、 <code>Best Practices</code> 、 <code>SEO</code> 和 <code>PWA</code> 在不同<code>设备</code>上的分数, 这些分数可以用于分析产品性能，帮助提升用户转化率等</li>
<li>不同于：<a href="https://treo.sh/" target="_blank" rel="noopener noreffer ">treo</a> 或者其他一些 Web 性能测试工具</li>
<li>它的优势是: <code>Open-Source</code>, <code>Free</code>, <code>Self-hosted</code> data and Server, <code>Easy to integrate</code>。</li>
</ul>
<h2 id="引用">引用</h2>
<ul>
<li><a href="https://web.dev/i18n/zh/why-speed-matters/" target="_blank" rel="noopener noreffer ">Get Down to Business: Why the Web Matters (Chrome Dev Summit 2018): https://web.dev/i18n/zh/why-speed-matters/</a></li>
<li><a href="https://web.dev/i18n/zh/why-speed-matters" target="_blank" rel="noopener noreffer ">为什么速度很重要？: https://web.dev/i18n/zh/why-speed-matters</a></li>
<li><a href="https://developers.google.cn/web/tools/lighthouse" target="_blank" rel="noopener noreffer ">Lighthouse: https://developers.google.cn/web/tools/lighthouse</a></li>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">博客:https://guzhongren.github.io/</a></li>
</ul>
<h2 id="免责声明">免责声明</h2>
<p>本文仅代表个人观点，与本人所供职的公司无任何关系。</p>
<hr>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: f2fe1394e4ab9297ed69ff73ac32e9ac1375f01c2102183b509bf9379a5995d6</p>
</blockquote>
<h2 id="赞助">赞助</h2>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: 964978ecd2059064abe542e51dc02e204d3ee2e6c320ca68e2b1399ce0c6953c</p>
</blockquote>
<blockquote>
<p>使用此<a href="https://guzhongren.github.io/images/pay/payforguzhongren.svg.sig" target="_blank" rel="noopener noreffer ">文件</a>进行校验： <code>gpg --verify PayForGuzhongren.svg.sig</code></p>
</blockquote>
]]></description></item><item><title>构建更优的 GitHub Action 完成 Algolia 数据上传</title><link>https://guzhongren.github.io/2022/01/%E6%9E%84%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84github-action%E5%AE%8C%E6%88%90algolia%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0/</link><pubDate>Thu, 20 Jan 2022 23:02:34 +0800</pubDate><author>谷中仁</author><guid>https://guzhongren.github.io/2022/01/%E6%9E%84%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84github-action%E5%AE%8C%E6%88%90algolia%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://cdn.staticaly.com/gh/guzhongren/data-hosting@main/DevOps/Github-Action.6lpf9wwtga80.webp" referrerpolicy="no-referrer">
            </div><h2 id="场景">场景</h2>
<p>程序员喜欢写博客，大都喜欢自己 Host 一个自己的 Blog, 通常 Blog 会有一个全局的搜索功能，开源博客一般都会选择 <a href="https://lunrjs.com/" target="_blank" rel="noopener noreffer ">lunrjs</a> 或者 <a href="https://www.algolia.com/" target="_blank" rel="noopener noreffer ">algolia</a> 等。我的 Blog 是基于 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer ">Hugo</a> 构建的，使用的主题是 <a href="https://hugoloveit.com/" target="_blank" rel="noopener noreffer ">LoveIt</a>, 集成的是 algolia 的搜索方式。</p>
<p>对于存储在 algolia 上的数据，我是通过 GitHub Action：<a href="https://github.com/marketplace/actions/algolia-docsearch-indexer" target="_blank" rel="noopener noreffer ">Algolia Docsearch Indexer</a> 来上传的，之前使用是没有问题的。</p>
<h2 id="问题">问题</h2>
<p>突然有一天我要使用搜索功能，但是怎么也搜索不到我想搜索的内容，看了 GitHub 项目的构建状态，一切正常，然后登陆到 algolia 后台一看， 最后一次的数据更新是在 21 年 8 月； 然后打开最近的博客构建记录，看了执行如下 GitHub workflow 的 yaml 日志，大吃一惊：程序执行错误，但还是在最后给我们送了一个🚀，同样是写代码，你能忍？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">darrenjennings/algolia-docsearch-action@master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">algolia_application_id</span><span class="p">:</span><span class="w"> </span><span class="l">${{secrets.ALGOLIA_APPLICATION_ID}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">algolia_api_key</span><span class="p">:</span><span class="w"> </span><span class="l">${{secrets.ALGOLIA_API_KEY}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;./public/index.json&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>运行日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Run</span> <span class="n">darrenjennings</span><span class="o">/</span><span class="n">algolia</span><span class="o">-</span><span class="n">docsearch</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">master</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">a682564a13d76444749d3b720346ba2365371_9474ad</span> <span class="o">--</span><span class="n">label</span> <span class="mi">6</span><span class="n">a6825</span> <span class="o">--</span><span class="n">workdir</span> <span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">workspace</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_ALGOLIA_APPLICATION_ID</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_ALGOLIA_API_KEY</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_FILE</span> <span class="o">-</span><span class="n">e</span> <span class="n">HOME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_JOB</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_SHA</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REPOSITORY</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REPOSITORY_OWNER</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_ID</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_NUMBER</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RETENTION_DAYS</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_ATTEMPT</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTOR</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_WORKFLOW</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_HEAD_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_BASE_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_EVENT_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_SERVER_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_API_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_GRAPHQL_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_PROTECTED</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_TYPE</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_WORKSPACE</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_EVENT_PATH</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION_REPOSITORY</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_PATH</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ENV</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_OS</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_ARCH</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_TOOL_CACHE</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_TEMP</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_WORKSPACE</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_RUNTIME_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_RUNTIME_TOKEN</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_CACHE_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTIONS</span><span class="o">=</span><span class="bp">true</span> <span class="o">-</span><span class="n">e</span> <span class="n">CI</span><span class="o">=</span><span class="bp">true</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/var/run/docker.sock&#34;</span><span class="p">:</span><span class="s2">&#34;/var/run/docker.sock&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_github_home&#34;</span><span class="p">:</span><span class="s2">&#34;/github/home&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_github_workflow&#34;</span><span class="p">:</span><span class="s2">&#34;/github/workflow&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_runner_file_commands&#34;</span><span class="p">:</span><span class="s2">&#34;/github/file_commands&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/blog/blog&#34;</span><span class="p">:</span><span class="s2">&#34;/github/workspace&#34;</span> <span class="mi">6</span><span class="n">a6825</span><span class="p">:</span><span class="mi">64</span><span class="n">a13d76444749d3b720346ba2365371</span>  <span class="s2">&#34;***&#34;</span> <span class="s2">&#34;***&#34;</span> <span class="s2">&#34;./public/index.json&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Cloning</span> <span class="n">into</span> <span class="s1">&#39;docsearch-scraper&#39;</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">pipenv</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">pipenv</span><span class="o">-</span><span class="mf">2021.11</span><span class="o">.</span><span class="mi">23</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">3.6</span> <span class="n">MB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">virtualenv</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">virtualenv</span><span class="o">-</span><span class="mf">20.10</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">5.6</span> <span class="n">MB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">pip</span><span class="o">&gt;=</span><span class="mf">18.0</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="n">from</span> <span class="n">pipenv</span><span class="p">)</span> <span class="p">(</span><span class="mf">21.2</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">setuptools</span><span class="o">&gt;=</span><span class="mf">36.2</span><span class="o">.</span><span class="mi">1</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="n">from</span> <span class="n">pipenv</span><span class="p">)</span> <span class="p">(</span><span class="mf">57.5</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="o">&gt;=</span><span class="mf">0.2</span><span class="o">.</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">virtualenv_clone</span><span class="o">-</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">6.6</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">certifi</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2021.10</span><span class="o">.</span><span class="mi">8</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">149</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="o">&gt;=</span><span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">importlib_resources</span><span class="o">-</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">28</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="o">&gt;=</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry_points_selectable</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">6.2</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">six</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">11</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="o">&gt;=</span><span class="mf">0.12</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">importlib_metadata</span><span class="o">-</span><span class="mf">4.8</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">17</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">filelock</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">3.2</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">filelock</span><span class="o">-</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">9.9</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">distlib</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">distlib</span><span class="o">-</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">4</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">461</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">platformdirs</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="o">&gt;=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">platformdirs</span><span class="o">-</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">14</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">zipp</span><span class="o">&gt;=</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">zipp</span><span class="o">-</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">5.3</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="o">&gt;=</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">typing_extensions</span><span class="o">-</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">22</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">zipp</span><span class="p">,</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="p">,</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="p">,</span> <span class="n">six</span><span class="p">,</span> <span class="n">platformdirs</span><span class="p">,</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="p">,</span> <span class="n">filelock</span><span class="p">,</span> <span class="n">distlib</span><span class="p">,</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="p">,</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="p">,</span> <span class="n">virtualenv</span><span class="p">,</span> <span class="n">certifi</span><span class="p">,</span> <span class="n">pipenv</span>
</span></span><span class="line"><span class="cl"><span class="n">WARNING</span><span class="p">:</span> <span class="n">Running</span> <span class="n">pip</span> <span class="n">as</span> <span class="n">the</span> <span class="s1">&#39;root&#39;</span> <span class="n">user</span> <span class="n">can</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">broken</span> <span class="n">permissions</span> <span class="ow">and</span> <span class="n">conflicting</span> <span class="n">behaviour</span> <span class="n">with</span> <span class="n">the</span> <span class="n">system</span> <span class="n">package</span> <span class="n">manager</span><span class="o">.</span> <span class="n">It</span> <span class="n">is</span> <span class="n">recommended</span> <span class="n">to</span> <span class="n">use</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">environment</span> <span class="n">instead</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pip</span><span class="o">.</span><span class="n">pypa</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">warnings</span><span class="o">/</span><span class="n">venv</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2021.10</span><span class="o">.</span><span class="mi">8</span> <span class="n">distlib</span><span class="o">-</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">4</span> <span class="n">filelock</span><span class="o">-</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">1</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="o">-</span><span class="mf">4.8</span><span class="o">.</span><span class="mi">3</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="o">-</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span> <span class="n">pipenv</span><span class="o">-</span><span class="mf">2021.11</span><span class="o">.</span><span class="mi">23</span> <span class="n">platformdirs</span><span class="o">-</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">0</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="o">-</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">1</span> <span class="n">virtualenv</span><span class="o">-</span><span class="mf">20.10</span><span class="o">.</span><span class="mi">0</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="o">-</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">7</span> <span class="n">zipp</span><span class="o">-</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">WARNING</span><span class="p">:</span> <span class="n">You</span> <span class="n">are</span> <span class="n">using</span> <span class="n">pip</span> <span class="n">version</span> <span class="mf">21.2</span><span class="o">.</span><span class="mi">4</span><span class="p">;</span> <span class="n">however</span><span class="p">,</span> <span class="n">version</span> <span class="mf">21.3</span><span class="o">.</span><span class="mi">1</span> <span class="n">is</span> <span class="n">available</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="n">should</span> <span class="n">consider</span> <span class="n">upgrading</span> <span class="n">via</span> <span class="n">the</span> <span class="s1">&#39;/usr/local/bin/python -m pip install --upgrade pip&#39;</span> <span class="n">command</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Installing</span> <span class="n">dependencies</span> <span class="n">from</span> <span class="n">Pipfile</span><span class="o">.</span><span class="n">lock</span> <span class="p">(</span><span class="n">aabb41</span><span class="p">)</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;docsearch&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">5</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/src/index.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">161</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/src/commands/run_config.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">21</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">run_config</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/../scraper/src/index.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">33</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_config</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/../scraper/src/config/config_loader.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">72</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl"><span class="n">AttributeError</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span> <span class="n">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;items&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">🚀</span> <span class="n">Successfully</span> <span class="n">indexed</span> <span class="ow">and</span> <span class="n">uploaded</span> <span class="n">the</span> <span class="n">results</span> <span class="n">to</span> <span class="n">Algolia</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>面对一个磨洋工的工具，作为程序员的我们肯定不能忍。
打开 GitHub 上这个 Action 的 <a href="https://github.com/darrenjennings/algolia-docsearch-action" target="_blank" rel="noopener noreffer ">源码</a>, 根据对 Action 构建的了解和现有代码，作者使用的是 Python 和 algolia 自己在 GitHub 上开源的 <a href="https://github.com/algolia/docsearch-scraper.git" target="_blank" rel="noopener noreffer ">工具</a>, 然后执行一个  Python 脚本上传文件到 algolia 的；根据以往经验，由 Python 构建的项目镜像一般都比较大，在本地测试了一下，果不其然的大。</p>
<h3 id="面临的问题">面临的问题</h3>
<ul>
<li>工具损坏</li>
<li>镜像体积大</li>
</ul>
<h2 id="方案-spike">方案 Spike</h2>
<table>
  <thead>
      <tr>
          <th>Item</th>
          <th>Option1 使用 algolia 自己的 Restful 接口</th>
          <th>Option 2 algolia SDK</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>描述</td>
          <td>使用 algolia 自己的 Restful 接口实现上传</td>
          <td>使用其官方提供的 SDK 编写代码来集成</td>
      </tr>
      <tr>
          <td>是否推荐</td>
          <td>No</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>实现难度</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
      <tr>
          <td>优点</td>
          <td>流程可控</td>
          <td>简单直接，无需担心错误情况的处理</td>
      </tr>
      <tr>
          <td>缺点</td>
          <td>需要写更多的代码来控制整个流程</td>
          <td>整个上传过程不可控</td>
      </tr>
      <tr>
          <td>安全问题</td>
          <td>No</td>
          <td>No</td>
      </tr>
      <tr>
          <td>相对难度</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
      <tr>
          <td>相对成本</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
  </tbody>
</table>
<p>综上分析，使用 Option2 SDK 的方案更佳。</p>
<h2 id="执行方案">执行方案</h2>
<p>新建 GitHub Action 项目，我们使用 Dockerfile 的方式构建上传索引的方案；</p>
<ul>
<li>新建 entrypoint.sh 并写入如下代码，脚本执行需要传入如下几个变量：</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Required</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>FILE_PATH</td>
          <td>要上传的文件路径</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>ALGOLIA_APPLICATION_ID</td>
          <td>Algolia 平台的应用 Id</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>ADMIN_API_KEY</td>
          <td>Algolia 上传所用的 API Key</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>INDEX_NAME</td>
          <td>在 Algolia 上你所创建的索引名</td>
          <td>Yes</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -eu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">npm install -g @algolia/cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">algolia import -s <span class="nv">$FILE_PATH</span> -a <span class="nv">$APPLICATION_ID</span> -k <span class="nv">$ADMIN_API_KEY</span> -n <span class="nv">$INDEX_NAME</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;0&#34;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;😢 Failed to upload your data to Algolia, PLZ report an issue, thx!&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;🚀 Successfully uploaded!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>新建 Dockerfile 并写入如下代码，在此我们使用最小化的 Node 镜像 <code>node:lts-alpine</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM node:lts-alpine
</span></span><span class="line"><span class="cl">COPY entrypoint.sh /entrypoint.sh
</span></span><span class="line"><span class="cl">ENTRYPOINT [&#34;/entrypoint.sh&#34;]
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更新 README, 完善使用文档。</li>
</ul>
<p>详细代码请参考 <a href="https://github.com/guzhongren/algolia-docsearch-upload-action/blob/main/Dockerfile" target="_blank" rel="noopener noreffer ">algolia-docsearch-upload-action</a>。</p>
<h2 id="验证结果">验证结果</h2>
<p>在完成 Action 并将其集成到 Pipeline 上之后，成功运行，数据可成功上传到 Algolia 平台上，并且博客的右上角的搜索功能可以成功搜索到最新的文章，说明我们的 Action 是可以完成我们的需求的。</p>
<h3 id="运行效率比较">运行效率比较</h3>
<p>没有对比就没有伤害。下面对我自己写的 Action 和之前集成过的 Action 在<code>镜像大小</code>和<code>执行效率</code>方面进行对比。</p>
<div class="echarts" id="id-1" style="width: 100%; height: 30rem;"></div>
<h3 id="镜像大小比较">镜像大小比较</h3>
<div class="echarts" id="id-2" style="width: 100%; height: 30rem;"></div>
<h2 id="引用">引用</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">博客：https://guzhongren.github.io/</a></li>
<li><a href="https://github.com/marketplace/actions/algolia-docsearch-indexer" target="_blank" rel="noopener noreffer ">Algolia Docsearch Indexer: https://github.com/marketplace/actions/algolia-docsearch-indexer</a></li>
<li><a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreffer ">GitHub Action: https://docs.github.com/en/actions</a></li>
</ul>
<h2 id="免责声明">免责声明</h2>
<p>本文仅代表个人观点，与本人所供职的公司无任何关系。</p>
<hr>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: f2fe1394e4ab9297ed69ff73ac32e9ac1375f01c2102183b509bf9379a5995d6</p>
</blockquote>
<h2 id="赞助">赞助</h2>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: 964978ecd2059064abe542e51dc02e204d3ee2e6c320ca68e2b1399ce0c6953c</p>
</blockquote>
<blockquote>
<p>使用此 <a href="https://guzhongren.github.io/images/pay/payforguzhongren.svg.sig" target="_blank" rel="noopener noreffer ">文件</a> 进行校验： <code>gpg --verify PayForGuzhongren.svg.sig</code></p>
</blockquote>
]]></description></item><item><title>性能优化 Accept-Encoding</title><link>https://guzhongren.github.io/2021/10/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-accept-encoding/</link><pubDate>Wed, 20 Oct 2021 21:43:03 +0800</pubDate><author>谷中仁</author><guid>https://guzhongren.github.io/2021/10/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-accept-encoding/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://cdn.staticaly.com/gh/guzhongren/data-hosting@main/accept-encoding.6zr4vfosvjk0.png" referrerpolicy="no-referrer">
            </div><h2 id="以前的网页请求">以前的网页请求</h2>
<div class="mermaid" id="id-1"></div>
<h2 id="人类总是在追求快更快">人类总是在追求快，更快</h2>
<p>随着带宽和基础设施的快速发展，网页显示速度也有迫切需求，随之，就出现了各种各样加速显示网页的技术。</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>HTTP compression<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><strong>HTTP compression</strong> is a capability that can be built into web servers and web clients to improve transfer speed and bandwidth utilization.  &ndash;wikipedia</div>
        </div>
    </div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Content Negotiation<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>In HTTP, content negotiation is the mechanism that is used for serving different representations of a resource to the same URI to help the user agent specify which representation is best suited for the user (for example, which document language, which image format, or which content encoding).</p>
<p>在 HTTP 协议中，内容协商是这样一种机制，通过为同一 URI 指向的资源提供不同的展现形式，可以使用户代理选择与用户需求相适应的最佳匹配（例如，文档使用的自然语言，图片的格式，或者内容编码形式）。</p>
</div>
        </div>
    </div>
<h2 id="内容协商的基本原则">内容协商的基本原则</h2>
<blockquote>
<p>一份特定的文件称为一项资源。当客户端获取资源的时候，会使用其对应的 URL 发送请求。服务器通过这个 URL 来选择它指向的资源的某一变体——每一个变体称为一种展现形式——然后将这个选定的展现形式返回给客户端。整个资源，连同它的各种展现形式，共享一个特定的 URL 。当一项资源被访问的时候，特定展现形式的选取是通过内容协商机制来决定的，并且客户端和服务器端之间存在多种协商方式。</p>
</blockquote>
<p></p>
<h3 id="内容协商类别">内容协商类别</h3>
<div class="mermaid" id="id-2"></div>
<p>随着时间的推移，也有其他一些内容协商的提案被提出来，比如透明内容协商以及 Alternates 首部。但是它们都没有获得人们的认可从而被遗弃。</p>
<h3 id="服务端驱动型内容协商机制流程">服务端驱动型内容协商机制流程</h3>
<div class="mermaid" id="id-3"></div>
<p>当客户端携带消息头（header）发送请求给服务端后，服务端使用消息头里的指定的可接受的压缩方式，自己通过内部特定的算法，找出最佳的压缩方案，然后将数据压缩并返回给客户端。</p>
<p></p>
<h4 id="用于启动服务端驱动型内容协商标准消息头">用于启动服务端驱动型内容协商标准消息头</h4>
<div class="mermaid" id="id-4"></div>
<p>这些消息头都是可以带有 Q 因子的清单；比如</p>
<table>
  <thead>
      <tr>
          <th>Item</th>
          <th>Example</th>
          <th>Note</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Accept</td>
          <td></td>
          <td>在获取 HTML 页面、图片文件、视频文件或者是脚本文件的时候，无论是通过在地址栏中输入资源地址来获取还是通过<code>&lt;img&gt;</code>、<code>&lt;video&gt;</code> 或 <code>&lt;audio&gt;</code> 元素引用都是不一样的。浏览器可以自由使用它们认为最为合适的首部值；</td>
      </tr>
      <tr>
          <td>Accept-Charset</td>
          <td><code>ISO-8859-1,utf-8;q=0.7,*;q=0.7</code></td>
          <td>如今 UTF-8 编码已经得到了广泛的支持，成为首选的字符编码类型，为了通过减少基于配置信息的信息熵来更好地保护隐私信息， 大多数浏览器会将 Accept-Charset 首部移除：Internet Explorer 8、Safari 5、Opera 11 以及 Firefox 10 都已经不再发送该首部。</td>
      </tr>
      <tr>
          <td>Accept-Encoding</td>
          <td><code>br, gzip;q=0.8</code></td>
          <td>将 HTTP 消息进行压缩是一种最重要的提升 Web 站点性能的方法。该方法会减小所要传输的数据量的大小，节省可用带宽。浏览器总是会发送该首部，服务器则应该配置为接受它，并且采用一定的压缩方案。</td>
      </tr>
      <tr>
          <td>Accept-Language</td>
          <td><code>de, en;q=0.7</code></td>
          <td>用户代理的图形界面上所采用的语言通常可以用来设置为默认值，但是大多数浏览器允许设置不同优先级的语言选项。</td>
      </tr>
  </tbody>
</table>
<p>某些情况下，服务器会使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Vary" target="_blank" rel="noopener noreffer ">Vary</a> 消息头来说明实际上哪些消息头被用作内容协商的参考依据（确切来说是与之相关的响应消息头），这样可以使 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching" target="_blank" rel="noopener noreffer ">缓存</a> 的运作更有效。</p>
<h4 id="vary-响应首部">Vary 响应首部</h4>
<p>前面列举的 Accept-* 形式的首部都是由客户端 (Web Client) 给服务端的，<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Vary" target="_blank" rel="noopener noreffer ">Vary</a> 首部是由服务器在响应 (Response) 中发送的。它标示了服务器在服务端驱动型内容协商阶段所使用的首部清单。这个首部是必要的，它是可以用来通知缓存服务器决策的依据，这样它可以进行复现，使得缓存服务器在预防将错误内容提供给用户方面发挥作用。</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Vary<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li>如果 Response 中 Vary 的值是&rsquo;*&rsquo;， 那么意味着在服务端驱动型内容协商过程中同时采纳了未在首部中传递的信息来选择合适的内容。</li>
<li>并且 Vary 的值是区分大消息的。</li>
</ul>
</div>
        </div>
    </div>
<h3 id="代理驱动型内容协商机制">代理驱动型内容协商机制</h3>
<p></p>
<p>服务端驱动型内容协商机制由于一些缺点而为人诟病——它在<strong>规模化</strong>方面存在问题。在协商机制中，每一个特性需要对应一个首部。如果想要使用屏幕大小、分辨率或者其他方面的特性，就需要创建一个新的首部。而且在每一次请求中都必须发送这些首部。在首部很少的时候，这并不是问题，但是随着数量的增多，消息体的体积会导致性能的下降。带有精确信息的首部发送的越多，信息熵就会越大，也就准许了更多 HTTP 指纹识别行为，以及与此相关的<strong>隐私问题</strong>的发生。</p>
<p>从 HTTP 协议制定之初，该协议就准许另外一种协商机制：代理驱动型内容协商机制，或称为响应式协商机制。<em>在这种协商机制中，当面临不明确的请求时，服务器会返回一个页面，其中包含了可供选择的资源的链接。资源呈现给用户，由用户做出选择。</em></p>
<p>不幸的是，HTTP 标准没有明确指定提供<strong>可选资源链接的页面的格式</strong>，这一点阻碍了将这一过程无痛自动化。除了退回至服务端驱动型内容协商机制外，这种自动化方法几乎无一例外都是通过<strong>脚本技术</strong>来完成的，尤其是 JavaScript 重定向技术：在检测了协商的条件之后，脚本会触发重定向动作。另外一个问题是，为了获得实际的资源，需要<strong>额外发送一次请求</strong>，<strong>减慢了将资源呈现给用户的速度</strong>。</p>
<h2 id="accept-encoding">Accept-Encoding</h2>
<p>HTTP Request Header 中的 <code>Accept-Encoding</code> 会将客户端（e.g. 浏览器）能够理解的内容编码方式（通常是某种压缩算法）通知给服务端。通过内容协商的方式，服务端会选择一个客户端提议的方式，使用并在响应头 Content-Encoding 中通知客户端该选择。</p>
<h3 id="压缩的好处">压缩的好处</h3>
<p>http 压缩对纯文本可以压缩至原内容的 40%, 从而节省了 60%的数据传输。</p>
<p>实例：访问我的博客网站，可以看到是进过 gzip 压缩的，原始大小为 34kB, 经过压缩后为 7.3kB，只有原先的 21%，在带宽上有很大的性能提升。</p>
<p>文件大小</p>
<p></p>
<p>gzip 压缩</p>
<p></p>
<h3 id="gzip-的缺点">Gzip 的缺点</h3>
<p>JPEG 这类文件用 gzip 压缩的不够好。</p>
<h3 id="gzip-是如何压缩的">Gzip 是如何压缩的</h3>
<p>简单来说， Gzip 压缩是在一个文本文件中找出类似的字符串， 并临时替换他们，使整个文件变小。这种形式的压缩对 Web 来说非常适合， 因为 HTML 和 CSS 文件通常包含大量的重复的字符串，例如空格，标签。</p>
<h3 id="语法">语法</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">Accept-Encoding: gzip
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: compress
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: deflate
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: br
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: identity
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: *
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">// Multiple algorithms, weighted with the quality value syntax:
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: deflate, gzip;q=1.0, *;q=0.5
</span></span></span></code></pre></td></tr></table>
</div>
</div><table>
  <thead>
      <tr>
          <th>Accept-Encoding type</th>
          <th>Note</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>gzip</td>
          <td>表示采用 <a href="http://en.wikipedia.org/wiki/LZ77_and_LZ78#LZ77" target="_blank" rel="noopener noreffer ">Lempel-Ziv coding (LZ77)</a> 压缩算法，以及 32 位 CRC 校验的编码方式。gzip 是 GNU zip 的缩写，是 GNU 自由软件的文件压缩程序，也用来表示 gzip 文件格式。<strong>浏览器支持的比较好</strong>。</td>
      </tr>
      <tr>
          <td>compress</td>
          <td>采用 <a href="http://en.wikipedia.org/wiki/LZW" target="_blank" rel="noopener noreffer ">Lempel-Ziv-Welch (LZW)</a> 压缩算法。</td>
      </tr>
      <tr>
          <td>deflate</td>
          <td>采用 <a href="http://en.wikipedia.org/wiki/Zlib" target="_blank" rel="noopener noreffer ">zlib</a> 结构和 <a href="http://en.wikipedia.org/wiki/DEFLATE" target="_blank" rel="noopener noreffer ">deflate</a> 压缩算法。使用 LZ77 算法于哈夫曼编码（Huffman Coding）的一种无损压缩算法</td>
      </tr>
      <tr>
          <td>br</td>
          <td>表示采用 <a href="https://en.wikipedia.org/wiki/Brotli" target="_blank" rel="noopener noreffer ">Brotli</a> 算法的编码方式。</td>
      </tr>
      <tr>
          <td>identity</td>
          <td>用于指代自身（例如：未经过压缩和修改）。除非特别指明，这个标记始终可以被接受。</td>
      </tr>
      <tr>
          <td>*</td>
          <td>匹配其他任意未在该请求头字段中列出的编码方式。假如该请求头字段不存在的话，这个值是默认值。它并不代表任意算法都支持，而仅仅表示算法之间无优先次序。</td>
      </tr>
      <tr>
          <td>;q= （权重系数）</td>
          <td>值代表优先顺序，用相对 <a href="https://developer.mozilla.org/en-US/docs/Glossary/Quality_values" target="_blank" rel="noopener noreffer ">权重系数</a> 表示，又称为质量价值。</td>
      </tr>
  </tbody>
</table>
<h3 id="示例">示例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">Accept-Encoding: gzip
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: gzip, compress, br
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Accept-Encoding: br;q=1.0, gzip;q=0.8, *;q=0.1
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="浏览器兼容性">浏览器兼容性</h3>
<p></p>
<h2 id="最佳实践">最佳实践</h2>
<p>对于 Accept-Encoding, 这个除了是后端请求，其他的只能由浏览器来自行设定，建议使用最新的浏览器即可。</p>
<p>对于 content-encoding 这个 header 只能由服务器来指定。针对不同的环境如 Nginx, Apache Tomcat 和 IIS 等，都有不同的配置，这里以 Nginx 为例，在 Nginx 的 *.conf 文件中加入如下代码即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">[root@linux /]# vim /usr/local/nginx/conf.d/www.conf
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">  listen 80;
</span></span><span class="line"><span class="cl">  server_name www.endvv.com endvv.com;
</span></span><span class="line"><span class="cl">  root html/bk;
</span></span><span class="line"><span class="cl">  index index.php index.html;
</span></span><span class="line"><span class="cl">  access_log /usr/local/nginx/logs/www.log ;
</span></span><span class="line"><span class="cl">  include /usr/local/nginx/php/www.conf;
</span></span><span class="line"><span class="cl">  include /usr/local/nginx/wjt/typecho.conf;
</span></span><span class="line"><span class="cl"><span class="gi">+ gzip on;
</span></span></span><span class="line"><span class="cl"><span class="gi">+ gzip_buffers 4 16k;
</span></span></span><span class="line"><span class="cl"><span class="gi">+ gzip_comp_level 6;
</span></span></span><span class="line"><span class="cl"><span class="gi">+ gzip_vary on;
</span></span></span><span class="line"><span class="cl"><span class="gi">+ gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="引用">引用</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">博客：https://guzhongren.github.io/</a></li>
<li><a href="https://en.wikipedia.org/wiki/HTTP_compression#cite_note-1" target="_blank" rel="noopener noreffer ">HTTP compression</a></li>
</ul>
<h2 id="免责声明">免责声明</h2>
<p>本文仅代表个人观点，与本人所供职的公司无任何关系。</p>
<hr>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: f2fe1394e4ab9297ed69ff73ac32e9ac1375f01c2102183b509bf9379a5995d6</p>
</blockquote>
<h2 id="赞助">赞助</h2>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: 964978ecd2059064abe542e51dc02e204d3ee2e6c320ca68e2b1399ce0c6953c</p>
</blockquote>
<blockquote>
<p>使用此 <a href="https://guzhongren.github.io/images/pay/payforguzhongren.svg.sig" target="_blank" rel="noopener noreffer ">文件</a> 进行校验： <code>gpg --verify PayForGuzhongren.svg.sig</code></p>
</blockquote>
]]></description></item></channel></rss>