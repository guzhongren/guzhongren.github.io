<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Deno - æ ‡ç­¾ - è°·ä¸­ä»çš„åšå®¢</title><link>https://guzhongren.github.io/tags/deno/</link><description>Deno - æ ‡ç­¾ - è°·ä¸­ä»çš„åšå®¢</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><copyright>Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Sun, 18 Oct 2020 17:43:16 +0800</lastBuildDate><atom:link href="https://guzhongren.github.io/tags/deno/" rel="self" type="application/rss+xml"/><item><title>è§£å†³ vscode é…ç½® deno æ—¶å‘½ä»¤ä¸å¯ç”¨çš„é—®é¢˜çš„è®°å½•</title><link>https://guzhongren.github.io/2020/10/%E8%A7%A3%E5%86%B3vscode%E9%85%8D%E7%BD%AEdeno%E6%97%B6%E5%91%BD%E4%BB%A4%E4%B8%8D%E5%8F%AF%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98%E7%9A%84%E8%AE%B0%E5%BD%95/</link><pubDate>Sun, 18 Oct 2020 17:43:16 +0800</pubDate><author>è°·ä¸­ä»</author><guid>https://guzhongren.github.io/2020/10/%E8%A7%A3%E5%86%B3vscode%E9%85%8D%E7%BD%AEdeno%E6%97%B6%E5%91%BD%E4%BB%A4%E4%B8%8D%E5%8F%AF%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98%E7%9A%84%E8%AE%B0%E5%BD%95/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://images.unsplash.com/photo-1671227498016-93aa927686f8?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1074&amp;q=80" referrerpolicy="no-referrer">
            </div><h2 id="ç¼˜ç”±">ç¼˜ç”±</h2>
<p>æœ€è¿‘åœ¨ç”¨<code>vscode</code>å†™<code>deno</code>, æœ€ä½³æ‹æ¡£åº”è¯¥å°±æ˜¯å®˜æ–¹æä¾›çš„æ’ä»¶äº†ï¼Œä½†æ˜¯ä½¿ç”¨æ’ä»¶éœ€è¦å¯¹é¡¹ç›®è¿›è¡Œåˆå§‹åŒ– (<code>deno:init</code>)ï¼Œå…¶å®å°±æ˜¯åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ (.vscode/settings.json)ï¼Œ ç„¶ååœ¨é‡Œé¢å†™å…¥ deno å¯¹è¯¥é¡¹ç›®çš„é…ç½®ã€‚</p>
<p>åœ¨æˆ‘åˆšå¼€å§‹å†™ deno ä»£ç çš„æ—¶å€™ï¼Œè¿™ä¸ªæ’ä»¶è¿˜æ˜¯å¥½çš„ï¼Œä½†æ˜¯å‚ä¸åˆ°æœ‹å‹çš„ä¸€ä¸ª demo çš„æ—¶å€™å°±å‡ºé—®é¢˜äº†ï¼› åˆå§‹åŒ–ï¼šCMD+ Shift + P,<code>deno:init</code>, ç„¶åå³ä¸‹è§’æç¤º<code>deno._init_project</code>æœªæ‰¾åˆ°ï¼Œè¯·é‡å¯ vscodeã€‚ç„¶åä¸ç®¡æ€ä¹ˆé‡å¯ï¼Œå³ä½¿æŠŠæ’ä»¶çš„æºç ä¸‹è½½ä¸‹æ¥ç¼–è¯‘è¿è¡Œéƒ½ä¸è¡Œã€‚æœ€ç»ˆåªæœ‰é‡æ–°å®‰è£…å¤§æ³•äº†ã€‚ç„¶è€Œï¼Œé‡è£…äº†è¿˜æ˜¯ä¸è¡Œã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>è§£å†³æ–¹æ¡ˆåº”è¯¥åªèƒ½æ˜¯å°†æ‰€æœ‰å…³äº vscode çš„æ‰€æœ‰æ’ä»¶å’Œé…ç½®éƒ½å½»åº•åˆ é™¤é‡æ–°å®‰è£…æ‰è¡Œã€‚</p>
<h3 id="åˆ é™¤æ’ä»¶">åˆ é™¤æ’ä»¶</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rm -rf ~/.vscode/extensions
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åˆ é™¤ç³»ç»Ÿç¼“å­˜æ•°æ®">åˆ é™¤ç³»ç»Ÿç¼“å­˜æ•°æ®</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rm -rf ~/Library/Application<span class="se">\ </span>Support/Code
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä»åº”ç”¨ç¨‹åºä¸­åˆ é™¤-vscode">ä»åº”ç”¨ç¨‹åºä¸­åˆ é™¤ vscode</h3>
<p>æ‰“å¼€ Mac çš„åº”ç”¨ç¨‹åºç®¡ç†æ–‡ä»¶å¤¹ï¼Œåˆ é™¤ <code>Visual Studio Code</code></p>
<h3 id="é‡æ–°å®‰è£…-vscode">é‡æ–°å®‰è£… vscode</h3>
<p>ç›´æ¥ä¸‹è½½å®‰è£…åŒ…æˆ–è€…ä½¿ç”¨ Homebrew</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">brew install visual-studio-code
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å®‰è£…-deno-æ’ä»¶">å®‰è£… deno æ’ä»¶</h3>
<p>åœ¨ vscode çš„æ‰©å±•ä¸­æœç´¢å¹¶å®‰è£… deno æ’ä»¶ã€‚</p>
<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<p>æ‰“å¼€ deno ç›¸å…³çš„é¡¹ç›®ã€‚CMD + Shift + P ï¼Œ è¾“å…¥ <code>denoï¼šinit</code>ï¼Œåº”è¯¥ä¸ä¼šå†å¼¹å‡ºå‘½ä»¤æ‰¾ä¸åˆ°çš„é”™è¯¯æç¤ºäº†ã€‚</p>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">åšå®¢ï¼šhttps://guzhongren.github.io/</a></li>
</ul>
<h2 id="å…è´£å£°æ˜">å…è´£å£°æ˜</h2>
<p>æœ¬æ–‡ä»…ä»£è¡¨ä¸ªäººè§‚ç‚¹ï¼Œä¸æœ¬äººæ‰€ä¾›èŒçš„å…¬å¸æ— ä»»ä½•å…³ç³»ã€‚</p>
<hr>
<p></p>
]]></description></item><item><title>åŸºäº oak çš„ä¸€æ¬¡ TDD å®è·µ</title><link>https://guzhongren.github.io/2020/07/%E5%9F%BA%E4%BA%8Eoak%E7%9A%84%E4%B8%80%E6%AC%A1tdd%E5%AE%9E%E8%B7%B5/</link><pubDate>Fri, 24 Jul 2020 22:21:11 +0800</pubDate><author>è°·ä¸­ä»</author><guid>https://guzhongren.github.io/2020/07/%E5%9F%BA%E4%BA%8Eoak%E7%9A%84%E4%B8%80%E6%AC%A1tdd%E5%AE%9E%E8%B7%B5/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://wx2.sbimg.cn/2020/07/28/PpGwl.jpg" referrerpolicy="no-referrer">
            </div><h2 id="talking-is-cheap-show-me-code"><code>Talking is cheap! Show me code!</code></h2>
<blockquote>
<p><a href="https://github.com/guzhongren/deno-restful-api-with-postgresql-tdd" target="_blank" rel="noopener noreffer ">æºç åœ°å€ï¼š<code>Deno Restful API With PostgreSql &amp; TDD</code></a></p>
</blockquote>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><code>Deno</code> æ˜¯<code>ry(Ryan Dahl)</code>çš„æ–°é¡¹ç›®ï¼Œè¿‘æœŸå‘å¸ƒäº†å…¶ <code>1.0.0</code> ç‰ˆï¼Œåœ¨å¼€å‘åœˆå­é‡Œæ€èµ·äº†ä¸å°çš„é£æµªï¼Œä¸ä¹‹åˆ›å»ºçš„ Node è¿è¡Œæ—¶æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œ<code>çœŸé¦™å®šå¾‹</code>åˆä¸€æ¬¡å‡ºç°äº†ã€‚</p>
<p>åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œä¸ºäº†å¼€å‘å‡ºå¯ç»´æŠ¤ï¼Œé«˜è´¨é‡çš„ç¨‹åºï¼Œä½¿ç”¨<code>TDD</code>å¼€å‘å¯ä»¥æœ‰æ•ˆæå‡é¡¹ç›®è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚</p>
<p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨<code>Deno</code>, <code>Typescript</code>, <code>PostgreSql</code>æ¥å¼€å‘ä¸€ä¸ªç”¨æˆ·ç®¡ç†çš„ <code>API</code> æ¥å£ã€‚</p>
<h2 id="deno--oak">Deno &amp; oak</h2>
<p>ä¸‹é¢éƒ½æ˜¯æ¥è‡ªå®˜ç½‘çš„ä»‹ç»ï¼Œå†™çš„å¾ˆé€šä¿—æ˜“æ‡‚ï¼Œå°±ä¸ç”¨æˆ‘æ¥è§£è¯»äº†ã€‚</p>
<h3 id="deno">Deno</h3>
<blockquote>
<p>Deno æ˜¯ä¸€ä¸ªç®€å•ã€ç°ä»£ä¸”å®‰å…¨çš„ JavaScript å’Œ TypeScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå…¶åŸºäº V8 å¼•æ“å¹¶é‡‡ç”¨ Rust ç¼–ç¨‹è¯­è¨€æ„å»ºã€‚</p>
<ul>
<li>é»˜è®¤å®‰å…¨è®¾ç½®ã€‚é™¤é æ˜¾å¼å¼€å¯ï¼Œå¦åˆ™æ²¡æœ‰æ–‡ä»¶ã€ç½‘ç»œï¼Œä¹Ÿä¸èƒ½è®¿é—®è¿è¡Œç¯å¢ƒã€‚</li>
<li>å¤©ç”Ÿæ”¯æŒ TypeScriptã€‚</li>
<li>åªæœ‰ä¸€ä¸ªå•ä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>è‡ªå¸¦å®ç”¨å·¥å…·ï¼Œä¾‹å¦‚ä¾èµ–æ£€æŸ¥å™¨ï¼ˆdeno infoï¼‰å’Œ ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼ˆdeno fmtï¼‰ã€‚</li>
<li>æœ‰ä¸€å¥—ç»è¿‡å®¡æ ¸ï¼ˆå®¡è®¡ï¼‰çš„æ ‡å‡†æ¨¡å—ï¼Œ ç¡®ä¿ä¸ Deno å…¼å®¹ï¼š deno.land/stdã€‚</li>
</ul>
</blockquote>
<h3 id="oakhttpsgithubcomoakserveroak"><a href="https://github.com/oakserver/oak" target="_blank" rel="noopener noreffer ">oak</a></h3>
<blockquote>
<p>A middleware framework for Deno&rsquo;s net server ğŸ¦•</p>
</blockquote>
<p><code>oak</code> æ˜¯å€Ÿé‰´ <code>Node</code> æ¡†æ¶<code>Koa</code>çš„è®¾è®¡æ€è·¯å¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½çš„æ¡†æ¶ï¼Œå…¶<code>æ´‹è‘±æ¨¡å‹</code>å¼çš„ä¸­é—´ä»¶ç­‰æ€è·¯åœ¨å¼€å‘ä¸­ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯éå¸¸æ–¹ä¾¿ã€‚</p>
<h2 id="ç›®æ ‡">ç›®æ ‡</h2>
<p>åŸºäºå¯¹ä»¥ä¸Šçš„åŸºç¡€çŸ¥è¯†çš„è®¤è¯†ï¼Œæˆ‘ä»¬è®¡åˆ’å¼€å‘ä¸€ä¸ªç”¨æˆ·ç®¡ç†çš„<code>API</code>å¹³å°ï¼›å¯¹äºåç«¯ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æä¾›å…³äºç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥ï¼ˆ<code>CURD</code>ï¼‰æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬çš„ä¸»è¦ç›®æ ‡å°±æ˜¯æä¾› 4 ä¸ªå¯¹ç”¨æˆ·<code>CURD</code>çš„æ¥å£ã€‚</p>
<h2 id="å·¥å…·">å·¥å…·</h2>
<blockquote>
<p>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚</p>
</blockquote>
<h3 id="å¼€å‘å·¥å…·">å¼€å‘å·¥å…·</h3>
<p><a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreffer "><code>VS Code</code></a>, <a href="https://www.docker.com/" target="_blank" rel="noopener noreffer "><code>Docker</code></a></p>
<h3 id="ç¯å¢ƒå·¥å…·">ç¯å¢ƒå·¥å…·</h3>
<p><a href="https://deno.land/" target="_blank" rel="noopener noreffer "><code>Deno</code></a>, <a href="https://www.typescriptlang.org/" target="_blank" rel="noopener noreffer "><code>Typescript</code></a>, <a href="https://nodejs.org/" target="_blank" rel="noopener noreffer "><code>Node</code></a></p>
<blockquote>
<p>æ³¨ï¼š Node æ˜¯ç”¨æ¥è°ƒè¯• Deno çš„</p>
</blockquote>
<h2 id="åŸºç¡€ç¯å¢ƒä¿¡æ¯">åŸºç¡€ç¯å¢ƒä¿¡æ¯</h2>
<p>æˆ‘çš„ç¯å¢ƒä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ node -v
</span></span><span class="line"><span class="cl">v12.13.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">â¯ deno --version
</span></span><span class="line"><span class="cl">deno 1.2.0
</span></span><span class="line"><span class="cl">v8 8.5.216
</span></span><span class="line"><span class="cl">typescript 3.9.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">â¯ docker --version
</span></span><span class="line"><span class="cl">Docker version 19.03.8, build afacb8b
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä»–ä¿¡æ¯</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">ç±»å‹</th>
          <th style="text-align: center">ç‰ˆæœ¬</th>
          <th style="text-align: center">å¤‡æ³¨</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><a href="https://hub.docker.com/_/postgres" target="_blank" rel="noopener noreffer ">PostgreSql</a></td>
          <td style="text-align: center">12</td>
          <td></td>
      </tr>
      <tr>
          <td style="text-align: left"><a href="https://hub.docker.com/r/dpage/pgadmin4" target="_blank" rel="noopener noreffer ">PGAdmin</a></td>
          <td style="text-align: center">latest</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ tree -L <span class="m">1</span> deno-restful-api-with-postgresql-tdd
</span></span><span class="line"><span class="cl">deno-restful-api-with-postgresql-tdd
</span></span><span class="line"><span class="cl">â”œâ”€â”€ .github         // github action
</span></span><span class="line"><span class="cl">â”œâ”€â”€ .vscode         // debug åŠ vscode é…ç½®æ–‡ä»¶
</span></span><span class="line"><span class="cl">â”œâ”€â”€ LICENSE         // ä»“åº“è®¸å¯
</span></span><span class="line"><span class="cl">â”œâ”€â”€ README.md       // é¡¹ç›®è¯´æ˜ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿æ¥ï¼Œç®€åŒ–åçš„è¿è¡Œå‘½ä»¤ç­‰
</span></span><span class="line"><span class="cl">â”œâ”€â”€ _resources      // åŸºç¡€èµ„æº
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ IaaS        // åŸºç¡€è®¾æ–½ï¼Œdocker-compose å¯åŠ¨ postgresql
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ httpClient  // http è¯·æ±‚æµ‹è¯•
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ migration   // è´Ÿè´£ç”Ÿæˆæ•°æ®åº“è¡¨
</span></span><span class="line"><span class="cl">â”œâ”€â”€ deps.ts         // é¡¹ç›®ä¾èµ–çš„åº“åŠé¡¹ç›®ä¸­è¦ç”¨åˆ°çš„èµ„æºï¼ˆimportï¼‰
</span></span><span class="line"><span class="cl">â”œâ”€â”€ lock.json       // å®Œæ•´æ€§æ£€æŸ¥ä¸é”å®šæ–‡ä»¶ï¼Œå‚è€ƒï¼šhttps://nugine.github.io/deno-manual-cn/linking_to_external_code/integrity_checking.html
</span></span><span class="line"><span class="cl">â”œâ”€â”€ makefile        // å°†å¼€å‘éœ€è¦çš„å‘½ä»¤è¡Œç®€åŒ–åç›®å½•
</span></span><span class="line"><span class="cl">â”œâ”€â”€ src             // æºä»£ç ç›®å½•
</span></span><span class="line"><span class="cl">â””â”€â”€ tests           // æµ‹è¯•ç›®å½•
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">5</span> directories, <span class="m">5</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2>
<blockquote>
<p>å…ˆè¯´æ˜ä¸€ä¸‹ï¼Œå¦‚æœè¦ç”¨æ–‡å­—å†™å®Œæ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸ªäººè®¤ä¸ºæ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œæ‰€ä»¥å°±ä»¥æœ€å¼€å§‹çš„<code>health</code>å’Œ<code>addUser</code>(<code>post</code>æ¥å£ï¼‰ä¸ºä¾‹ï¼Œ å…¶ä»–æ¥å£è¯·å‚è€ƒ <a href="https://github.com/guzhongren/deno-restful-api-with-postgresql-tdd" target="_blank" rel="noopener noreffer ">ä»£ç å®ç°</a>ã€‚</p>
</blockquote>
<h3 id="å¯åŠ¨åŸºç¡€è®¾æ–½æ•°æ®åº“å¹¶åˆå§‹åŒ–æ•°æ®è¡¨">å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ï¼‰å¹¶åˆå§‹åŒ–æ•°æ®è¡¨</h3>
<h4 id="å¯åŠ¨æ•°æ®åº“">å¯åŠ¨æ•°æ®åº“</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make db
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ./_resources/Iaas <span class="o">&amp;&amp;</span> docker-compose up -d
</span></span><span class="line"><span class="cl">Starting iaas_db_1 ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Starting iaas_pgadmin_1 ... <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç™»å½•pgadmin-åœ¨é»˜è®¤çš„æ•°æ®åº“postgresä¸­æ–°å»ºqueryå¹¶æ‰§è¡Œå¦‚ä¸‹æ“ä½œå®Œæˆåˆå§‹åŒ–æ•°æ®åº“">ç™»å½•<code>pgadmin</code>, åœ¨é»˜è®¤çš„æ•°æ®åº“<code>postgres</code>ä¸­æ–°å»º<code>Query</code>å¹¶æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œå®Œæˆåˆå§‹åŒ–æ•°æ®åº“</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="s2">&#34;user&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="nb">varying</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">registration_date</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="nb">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">deleted</span><span class="w"> </span><span class="nb">boolean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="src-æœ€ç»ˆç›®å½•">src æœ€ç»ˆç›®å½•</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ tree -a -L <span class="m">4</span> src
</span></span><span class="line"><span class="cl">src
</span></span><span class="line"><span class="cl">â”œâ”€â”€ Utils
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ client.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ config.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ controllers
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ UserController.ts
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ health.ts
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ model
</span></span><span class="line"><span class="cl">â”‚       â””â”€â”€ IResponse.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ entity
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ User.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ exception
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ InvalidedParamsException.ts
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ NotFoundException.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ index.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ middlewares
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ error.ts
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ logger.ts
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ time.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ repositories
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ userRepo.ts
</span></span><span class="line"><span class="cl">â”œâ”€â”€ router.ts
</span></span><span class="line"><span class="cl">â””â”€â”€ services
</span></span><span class="line"><span class="cl">    â”œâ”€â”€ UserService.ts
</span></span><span class="line"><span class="cl">    â””â”€â”€ fetchResource.ts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">8</span> directories, <span class="m">16</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€äº›å¸¸ç”¨çš„ç»“æ„ä½“å’Œå¯¹è±¡ï¼Œå¦‚ï¼šresponseï¼Œexception ç­‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/controllers/model/IResponse.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">interface</span> <span class="nx">IResponse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">success</span>: <span class="kt">boolean</span><span class="p">;</span> <span class="c1">// è¡¨ç¤ºæ­¤æ¬¡è¯·æ±‚æ˜¯å¦æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">msg?</span>: <span class="kt">String</span><span class="p">;</span>     <span class="c1">// å‘ç”Ÿé”™è¯¯æ—¶çš„ä¸€äº›æ—¥å¿—ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">data?</span>: <span class="kt">any</span><span class="p">;</span>       <span class="c1">// è¯·æ±‚æˆåŠŸæ—¶è¿”å›ç»™å‰ç«¯çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/entity/User.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">interface</span> <span class="nx">IUser</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">username?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registrationDate?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">deleted?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">User</span> <span class="kr">implements</span> <span class="nx">IUser</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¼‚å¸¸ç”¨æ¥å¤„ç†é”™è¯¯æƒ…å†µï¼Œåœ¨æœ€ç»ˆè¿”å›ç»™ç”¨æˆ·ç»“æœçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½å°†å¼‚å¸¸è¿”å›ç»™ç”¨æˆ·ï¼Œè€Œæ˜¯ä»¥ä¸€ç§æ›´å‹å¥½çš„æ–¹å¼è¿”å›ï¼Œå…·ä½“æµç¨‹å¯ä»¥å‚è€ƒ<code>src/middlewares/error.ts</code>è¿™ä¸ªä¸­é—´ä»¶çš„å¤„ç†æ–¹å¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/exception/InvalidedParamsException.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">InvalidedParamsException</span> <span class="kr">extends</span> <span class="nb">Error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">(</span><span class="sb">`Invalided parameters, please check, </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/exception/NotFoundException.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">NotFoundException</span> <span class="kr">extends</span> <span class="nb">Error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">(</span><span class="sb">`Not found resource, </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä¾èµ–ç®¡ç†">ä¾èµ–ç®¡ç†</h3>
<p>Deno æ²¡æœ‰åƒ Node ä¸€æ ·çš„è¯¸å¦‚<code>package.json</code>æ¥ç®¡ç†ä¾èµ–ï¼Œå› ä¸º<code>Deno</code>çš„ä¾èµ–æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œä¹Ÿå°±æ˜¯ä»¥è¿œç¨‹æ–‡ä»¶ä½œä¸ºåº“ï¼Œè¿™ä¸€ç‚¹å’Œ<code>Golang</code>å¾ˆåƒã€‚</p>
<p>æˆ‘å°†ç³»ç»Ÿä¸­ç”¨åˆ°çš„ä¾èµ–å­˜æ”¾åœ¨æ ¹ç›®å½•çš„<code>deps.ts</code>ä¸­ï¼Œåœ¨æœ€ç»ˆæäº¤çš„æ—¶å€™åšä¸€æ¬¡ <a href="https://nugine.github.io/deno-manual-cn/linking_to_external_code/integrity_checking.html" target="_blank" rel="noopener noreffer "><code>å®Œæ•´æ€§æ£€æŸ¥ä¸é”å®šæ–‡ä»¶</code></a>, æ¥ä¿è¯æˆ‘æ‰€æœ‰çš„ä¾èµ–åœ¨ä¸å…¶ä»–åä½œè€…ä¹‹é—´æ˜¯ç›¸åŒçš„ã€‚</p>
<p>é¦–å…ˆå¯¼å…¥ç”¨åˆ°çš„æµ‹è¯•ç›¸å…³çš„ä¾èµ–ã€‚<strong>åœ¨åé¢å¼€å‘ä¸­ç”¨åˆ°çš„ç›¸å…³ä¾èµ–è¯·è‡ªè¡Œæ·»åŠ åˆ°æœ¬æ–‡ä»¶ä¸­ã€‚</strong> æ¯”è¾ƒé‡è¦çš„æˆ‘ä¼šåˆ—å‡ºæ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assert</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">equal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;https://deno.land/std/testing/asserts.ts&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æµ‹è¯•å…ˆè¡Œ">æµ‹è¯•å…ˆè¡Œ</h3>
<p>ç°åœ¨<code>tests</code>ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæµ‹è¯•å‘½åä¸º<code>index.test.ts</code>, å†™åŸºæœ¬æµ‹è¯•ï¼Œè¯æ˜æµ‹è¯•å’Œç¨‹åºæ˜¯å¯ä»¥<code>work</code>çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">assert</span><span class="p">,</span> <span class="nx">equal</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;should work&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">universal</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">equal</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nx">universal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assert</span><span class="p">(</span><span class="mi">42</span> <span class="o">===</span> <span class="nx">universal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç¬¬ä¸€æ¬¡è¿è¡Œæµ‹è¯•">ç¬¬ä¸€æ¬¡è¿è¡Œæµ‹è¯•</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make <span class="nb">test</span>
</span></span><span class="line"><span class="cl">deno <span class="nb">test</span> --allow-env --allow-net -L info
</span></span><span class="line"><span class="cl">Check file:///xxxx/deno-restful-api-with-postgresql-tdd/.deno.test.ts
</span></span><span class="line"><span class="cl">running <span class="m">1</span> tests
</span></span><span class="line"><span class="cl"><span class="nb">test</span> should work ... ok <span class="o">(</span>6ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">1</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out <span class="o">(</span>6ms<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å»ºç«‹æµ‹è¯•å›ºä»¶">å»ºç«‹æµ‹è¯•å›ºä»¶</h3>
<p>å°†æµ‹è¯•ä¸­ç”¨åˆ°çš„é€šç”¨çš„æµ‹è¯•ä¿¡æ¯å­˜æ”¾åœ¨æµ‹è¯•å›ºä»¶ï¼ˆ<code>testFixtures</code>ï¼‰ä¸­ï¼Œå¯ä»¥åœ¨æµ‹è¯•ä¸­å¤ç”¨ï¼Œä¸”å¯ä»¥ç®€åŒ–ä»£ç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// tests/testFixtures.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">TEST_PORT</span> <span class="o">=</span> <span class="mi">9000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="health-æ¥å£">health æ¥å£</h3>
<p><code>health</code> æ¥å£å¯ä»¥ä½œä¸ºç³»ç»Ÿçš„å¥åº·æ£€æŸ¥çš„ä¸€ä¸ªå‡ºå£ï¼Œåœ¨è¿ç»´å¹³å°ä¸­éå¸¸å®ç”¨ã€‚å¯¹äºæ­¤æ¥å£ï¼Œæˆ‘ä»¬åªéœ€è¦è¿”å›ä¸€ä¸ªçŠ¶æ€<code>OK</code>å³å¯ã€‚å…¶ä»–æƒ…å†µå¯å¿½ç•¥ã€‚é‚£ä¹ˆå¯¹åº”çš„<code>Todo</code>åº”è¯¥å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å½“è®¿é—®åˆ°ç³»ç»Ÿçš„æ—¶å€™ï¼Œåº”è¯¥è¿”å›ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¸”ä¸º OKã€‚</p>
</blockquote>
<p>æ‰€ä»¥ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Application</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">getHealthInfo</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../src/controllers/health.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span><span class="nx">TEST_PORT</span><span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;../testFixtures.ts&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;health check&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">expectResponse</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="s2">&#34;Ok&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">abortController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">signal</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">abortController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">router</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;/health&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">({</span> <span class="nx">response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getHealthInfo</span><span class="p">({</span> <span class="nx">response</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span> <span class="nx">port</span>: <span class="kt">TEST_PORT</span><span class="p">,</span> <span class="nx">signal</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://127.0.0.1:</span><span class="si">${</span><span class="nx">TEST_PORT</span><span class="si">}</span><span class="sb">/health`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">responseJSON</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">responseJSON</span><span class="p">,</span> <span class="nx">expectResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">abortController</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="given">given</h4>
<blockquote>
<ul>
<li>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆå£°æ˜äº†æˆ‘ä»¬æœŸæœ›çš„æ•°æ®ç»“æ„ï¼Œå³<code>expectResponse</code>ï¼›</li>
<li>ç„¶ååˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå’Œä¸€ä¸ªè·¯ç”±ï¼Œ</li>
<li>å†åˆ›å»ºä¸€ä¸ªç»ˆæ­¢åº”ç”¨çš„æ§åˆ¶å™¨ï¼Œä¸”ä»ä¸­å–åˆ°ä¿¡å·æ ‡è¯†ï¼Œ</li>
<li>æ¥ç€ï¼Œ å‘è·¯ç”±ä¸­æ·»åŠ ä¸€ä¸ª<code>health</code>è·¯ç”±åŠå…¶ handlerï¼›</li>
<li>ç„¶åå°†è·¯ç”±æŒ‚åœ¨åˆ°åº”ç”¨ç¨‹åºä¸Šï¼›</li>
<li>ç›‘å¬åº”ç”¨ç¨‹åºç«¯å£ï¼Œä¸”ä¼ å…¥åº”ç”¨ç¨‹åºä¿¡å·ã€‚</li>
</ul>
</blockquote>
<h4 id="when">when</h4>
<blockquote>
<ul>
<li>ç»™å¯åŠ¨çš„åº”ç”¨å‘ä¸€ä¸ª get è¯·æ±‚ï¼Œè¯·æ±‚è·¯å¾„ä¸º<code>/health</code>;</li>
</ul>
</blockquote>
<h4 id="then">then</h4>
<blockquote>
<ul>
<li>æ ¹æ® fetch åˆ°çš„ç»“æœè¿›è¡Œåˆ¤å®šï¼Œçœ‹æ”¶åˆ°çš„<code>response</code>æ˜¯ä¸æ˜¯å’ŒæœŸæœ›çš„ä¸€è‡´ï¼Œ ä¸”åœ¨æœ€åç»ˆæ­¢ä¸Šé¢çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>åˆ°æ­¤ï¼Œå¦‚æœè¿è¡Œæµ‹è¯•è‚¯å®šä¼šå‘ç”Ÿé”™è¯¯ï¼Œè§£å†³é—®é¢˜çš„ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å»å®ç°<code>getHealthInfo</code> handlerã€‚</li>
</ul>
</blockquote>
<h4 id="å®ç°-gethealthinfo-handler">å®ç° <code>getHealthInfo</code> handler</h4>
<p>åœ¨ src/controller ä¸‹æ–°å»º<code>health.ts</code>ï¼Œå¹¶ä»¥æœ€ç®€å•çš„æ–¹æ¡ˆå®ç°ä¸Šé¢æœŸæœ›çš„ç»“æœï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/controllers/health.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">Status</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IResponse</span> <span class="kr">from</span> <span class="s2">&#34;./model/IResponse.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">getHealthInfo</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">response</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">response</span>: <span class="kt">Response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">Status</span><span class="p">.</span><span class="nx">OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">res</span>: <span class="kt">IResponse</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="s2">&#34;Ok&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</h4>
<p>è¿è¡Œæµ‹è¯•å‘½ä»¤ï¼Œæµ‹è¯•é€šè¿‡ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make <span class="nb">test</span>
</span></span><span class="line"><span class="cl">deno <span class="nb">test</span> --allow-env --allow-net -L info
</span></span><span class="line"><span class="cl">Check file://xxx/deno-restful-api-with-postgresql-tdd/.deno.test.ts
</span></span><span class="line"><span class="cl">running <span class="m">2</span> tests
</span></span><span class="line"><span class="cl"><span class="nb">test</span> should work ... ok <span class="o">(</span>6ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> health check ... ok <span class="o">(</span>3ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">2</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out <span class="o">(</span>9ms<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œä½¿ç”¨<code>TDD</code>å®Œæˆç¬¬ä¸€ä¸ªç®€å•çš„<code>health</code>æ¥å£ï¼›ä½†å¯¹å¤–æ²¡æœ‰æš´éœ²æ¥å£ï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>src</code>ç›®å½•ä¸­å®ç°ä¸€ä¸ªå¯¹å¤–æš´éœ²è¯¥æ¥å£çš„åº”ç”¨ã€‚</p>
<h5 id="æ–°å»ºconfigts-åšåº”ç”¨ç¨‹åºçš„é…ç½®ç®¡ç†æ–‡ä»¶">æ–°å»º<code>config.ts</code>ï¼Œ åšåº”ç”¨ç¨‹åºçš„é…ç½®ç®¡ç†æ–‡ä»¶</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/config.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">APP_HOST</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">APP_HOST</span> <span class="o">||</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">APP_PORT</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_PORT</span><span class="p">)</span> <span class="o">||</span> <span class="mi">8000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">API_VERSION</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span> <span class="o">||</span> <span class="s2">&#34;/api/v1&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½®æ–‡ä»¶ä¸­ï¼Œè®°å½•äº†åº”ç”¨ç¨‹åºå¯åŠ¨çš„é»˜è®¤ host, ç«¯å£ï¼ŒåŠæ•°æ®åº“ç›¸å…³çš„ä¿¡æ¯ï¼Œæœ€åè®°å½•äº†åº”ç”¨ç¨‹åº api çš„å‰ç¼€ã€‚</p>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦åœ¨<code>deps.ts</code>ä¸­å¼•å…¥æ‰€éœ€è¦çš„åº“ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Application</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouteParams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouterContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">helpers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">send</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;https://deno.land/x/oak/mod.ts&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ–°å»ºè·¯ç”±-routerts-å¼•å…¥heathtså¹¶ç»‘å®šè·¯ç”±">æ–°å»ºè·¯ç”± <code>router.ts</code>, å¼•å…¥<code>Heath.ts</code>å¹¶ç»‘å®šè·¯ç”±</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/router.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">API_VERSION</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./config.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">getHealthInfo</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./controllers/health.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">prefix</span><span class="p">(</span><span class="nx">API_VERSION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;/health&#34;</span><span class="p">,</span> <span class="nx">getHealthInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">router</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ–°å»ºindexts-å»ºç«‹åº”ç”¨ç¨‹åº">æ–°å»º<code>index.ts</code>, å»ºç«‹åº”ç”¨ç¨‹åº</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/index.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Application</span><span class="p">,</span> <span class="nx">send</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">APP_HOST</span><span class="p">,</span> <span class="nx">APP_PORT</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./config.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">router</span> <span class="kr">from</span> <span class="s2">&#34;./router.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">listenToServer</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">app</span>: <span class="kt">Application</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="sb">`Application started, and listen to </span><span class="si">${</span><span class="nx">APP_HOST</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">APP_PORT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hostname</span>: <span class="kt">APP_HOST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">port</span>: <span class="kt">APP_PORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">secure</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createApplication</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">Application</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createApplication</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">listenToServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å¯åŠ¨åº”ç”¨">å¯åŠ¨åº”ç”¨</h5>
<p>å¦‚æœæ˜¯<code>VSCode</code>ï¼Œ å¯ä»¥ä½¿ç”¨<code>F5</code>åŠŸèƒ½é”®ï¼Œå¿«é€Ÿå¯åŠ¨åº”ç”¨ï¼Œåœ¨ä½ç‰ˆæœ¬çš„ <code>VS Code(1.47.2 ä»¥ä¸‹ï¼‰</code> ä¸­å¯ä»¥å¯åŠ¨è°ƒè¯•ã€‚ä¹Ÿå¯ä»¥ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make dev
</span></span><span class="line"><span class="cl">deno run --allow-net --allow-env ./src/index.ts
</span></span><span class="line"><span class="cl">æ•°æ®åº“é“¾æ¥æˆåŠŸï¼
</span></span><span class="line"><span class="cl">Application started, and listen to 127.0.0.1:8000
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è°ƒç”¨æ¥å£æµ‹è¯•ç»“æœ">è°ƒç”¨æ¥å£æµ‹è¯•ç»“æœ</h5>
<p>è¿™é‡Œä½¿ç”¨<code>VS Code</code> çš„ <a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client" target="_blank" rel="noopener noreffer "><code>Rest Client</code></a> æ’ä»¶è¿›è¡Œè¾…åŠ©æµ‹è¯•ã€‚</p>
<h6 id="è¯·æ±‚ä½“">è¯·æ±‚ä½“</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// _resources/httpClient/healthCheck.http
</span></span><span class="line"><span class="cl">GET http://localhost:8000/api/v1/health HTTP/1.1
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="è¯·æ±‚ç»“æœ">è¯·æ±‚ç»“æœ</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">content-length: 28
</span></span><span class="line"><span class="cl">x-response-time: 0ms
</span></span><span class="line"><span class="cl">content-type: application/json; charset=utf-8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;success&#34;: true,
</span></span><span class="line"><span class="cl">  &#34;data&#34;: &#34;Ok&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œå®Œæˆç¬¬ä¸€ä¸ªæ¥å£ï¼Œæœ‰ <code>Oak</code> æä¾›åº”ç”¨æœåŠ¡ï¼Œç»è¿‡äº†<code>Unit test</code>å’Œ <code>RestClient</code>çš„æµ‹è¯•ã€‚å®Œæˆäº†å¼€å§‹çš„<code>Todo</code>ã€‚</p>
<h3 id="æ·»åŠ ç”¨æˆ·æ¥å£-adduser">æ·»åŠ ç”¨æˆ·æ¥å£ (<code>addUser</code>)</h3>
<p>æ·»åŠ ç”¨æˆ·æ¶‰åŠåˆ°<code>Controller</code>, <code>Service</code> å’Œ <code>Repository</code>, æ‰€ä»¥æˆ‘ä»¬åˆ†ä¸‰æ­¥æ¥å®ç°è¯¥æ¥å£ã€‚</p>
<h4 id="controller">Controller</h4>
<p><code>Controller</code> æ˜¯æ§åˆ¶å±‚ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼›æ·»åŠ ç”¨æˆ·æ¥å£å¯ä»¥ä¸ºç³»ç»Ÿæ·»åŠ ç”¨æˆ·ï¼Œé‚£ä¹ˆå¯¹åº”çš„<code>Todo</code>å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li>è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿”å›ç‰¹å®šæ•°æ®ç»“æ„çš„ç”¨æˆ·ä¿¡æ¯</li>
<li>å‚æ•°å¿…é¡»è¾“å…¥ï¼Œå¦åˆ™æŠ›å¼‚å¸¸</li>
<li>å¦‚æœè¾“å…¥é”™è¯¯å‚æ•°ï¼Œåˆ™æŠ›å¼‚å¸¸</li>
</ul>
</blockquote>
<p>åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° <a href="https://github.com/udibo/mock" target="_blank" rel="noopener noreffer "><code>mock</code></a> æ¥ <code>mock</code> ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚</p>
<p>å¯¼å…¥æ‰€éœ€ä¾èµ–ï¼Œå¹¶æ–°å»º<code>UserController.test.ts</code>ï¼Œåœ¨<code>Coding</code> è¿‡ç¨‹ä¸­éœ€è¦å®ç°<code>UserService</code>, ä½†ä¸éœ€è¦å®ç°<code>addUser</code>æ–¹æ³•ï¼› æµ‹è¯•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// tests/controllers/UserController.test.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">v4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertThrowsAsync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Application</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">UserController</span> <span class="kr">from</span> <span class="s2">&#34;../../src/controllers/UserController.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IResponse</span> <span class="kr">from</span> <span class="s2">&#34;../../src/controllers/model/IResponse.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">UserService</span> <span class="kr">from</span> <span class="s2">&#34;../../src/services/UserService.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IUser</span><span class="p">,</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../src/entity/User.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">InvalidedParamsException</span> <span class="kr">from</span> <span class="s2">&#34;../../src/exception/InvalidedParamsException.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span><span class="nx">TEST_PORT</span><span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;../testFixtures.ts&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">generate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">registrationDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toISOString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">mockedUser</span>: <span class="kt">User</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id</span>: <span class="kt">userId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">username</span><span class="o">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registrationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">deleted</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;#addUser should return added user when add user&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">queryAllStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">UserService</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">userService</span><span class="p">,</span> <span class="s2">&#34;addUser&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">expectResponse</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span>: <span class="kt">mockedUser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedUser</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userController</span><span class="p">.</span><span class="nx">userService</span> <span class="o">=</span> <span class="nx">userService</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">abortController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">signal</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">abortController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/users&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">await</span> <span class="nx">userController</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span> <span class="nx">port</span>: <span class="kt">TEST_PORT</span><span class="p">,</span> <span class="nx">signal</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://127.0.0.1:</span><span class="si">${</span><span class="nx">TEST_PORT</span><span class="si">}</span><span class="sb">/users`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="s2">&#34;name=name&amp;password=123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Content-Type&#34;</span><span class="o">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">responseJSON</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">responseJSON</span><span class="p">,</span> <span class="nx">expectResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">abortController</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;#addUser should throw exception about no params given no params when add user&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">queryAllStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">UserService</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">userService</span><span class="p">,</span> <span class="s2">&#34;addUser&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedUser</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userController</span><span class="p">.</span><span class="nx">userService</span> <span class="o">=</span> <span class="nx">userService</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">abortController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">signal</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">abortController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/users&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="nx">assertThrowsAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="nx">userController</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">InvalidedParamsException</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;should given params: name ...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">abortController</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span> <span class="nx">port</span>: <span class="kt">TEST_PORT</span><span class="p">,</span> <span class="nx">signal</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://127.0.0.1:</span><span class="si">${</span><span class="nx">TEST_PORT</span><span class="si">}</span><span class="sb">/users`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Content-Type&#34;</span><span class="o">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="o">!</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;#addUser should throw exception about no correct params given wrong params when add user&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">queryAllStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">UserService</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">userService</span><span class="p">,</span> <span class="s2">&#34;addUser&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedUser</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userController</span><span class="p">.</span><span class="nx">userService</span> <span class="o">=</span> <span class="nx">userService</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">abortController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">signal</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">abortController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/users&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="nx">assertThrowsAsync</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="nx">userController</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">InvalidedParamsException</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;should given param name and password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">abortController</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span> <span class="nx">port</span>: <span class="kt">TEST_PORT</span><span class="p">,</span> <span class="nx">signal</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://127.0.0.1:</span><span class="si">${</span><span class="nx">TEST_PORT</span><span class="si">}</span><span class="sb">/users`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">method</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="s2">&#34;wrong=params&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Content-Type&#34;</span><span class="o">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="o">!</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>controller</code> è¿™ä¸€å±‚éœ€è¦è°ƒç”¨<code>service</code>çš„æœï¼›ä½œä¸º<code>service</code>ï¼Œå¯¹äº<code>controller</code>æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå› æ­¤éœ€è¦å°†<code>service</code>çš„æ–¹æ³•<code>mock</code>ï¼Œå¹¶ä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥<code>Controller</code>; ä¸‹é¢è¿™æ®µä»£ç å°±æ˜¯<code>mock</code>çš„åº”ç”¨ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">queryAllStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">UserService</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">userService</span><span class="p">,</span> <span class="s2">&#34;addUser&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">expectResponse</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span>: <span class="kt">mockedUser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queryAllStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedUser</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userController</span><span class="p">.</span><span class="nx">userService</span> <span class="o">=</span> <span class="nx">userService</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ­¤è§£é‡Šä¸¤ä¸ªæµ‹è¯•ï¼Œç¬¬ä¸€ä¸ªæµ‹è¯•å³<code>#addUser should return added user when add user</code>;</p>
<h5 id="given-1">given</h5>
<blockquote>
<ul>
<li>mock <code>UserService</code>, ç»™ UserService çš„ <code>addUser</code>æ–¹æ³•æ‰“æ¡©ï¼Œå¹¶è¿”å›ç‰¹å®šçš„ç”¨æˆ·ç»“æ„ï¼›</li>
<li>æ–°å»ºæµ‹è¯•æœåŠ¡ï¼Œå¹¶å°† <code>UserController</code>æ³¨å†Œç»™ post æ¥å£ <code>/users</code>;</li>
</ul>
</blockquote>
<h5 id="when-1">when</h5>
<blockquote>
<ul>
<li>ä¼ å…¥æ­£ç¡®çš„ form ç±»å‹çš„å‚æ•°ï¼Œç”¨<code>fetch</code>è¯·æ±‚<code>http://127.0.0.1:9000/users</code>;</li>
</ul>
</blockquote>
<h5 id="then-1">then</h5>
<blockquote>
<ul>
<li>å¯¹è·å–åˆ°çš„ç»“æœè¿›è¡Œåˆ¤å®šï¼Œå¹¶ä¸­æ–­æµ‹è¯•åº”ç”¨ï¼Œå°†æ‰“æ¡©çš„æ–¹æ³•æ¢å¤ã€‚</li>
</ul>
</blockquote>
<p>åœ¨æ­¤è§£é‡Šä¸¤ä¸ªæµ‹è¯•ï¼Œç¬¬äºŒä¸ªæµ‹è¯•å³<code>#addUser should throw exception about no params given no params when add user</code>; <code>given</code>å’Œ<code>when</code>ä¸ç¬¬ä¸€ä¸ªæµ‹è¯•çš„<code>given</code>å’Œ<code>when</code>æŸ¥ä¸å¤šï¼Œåªæ˜¯<code>body</code>å‚æ•°ä¸ºç©ºï¼›æœ€é‡è¦çš„ä¸åŒç‚¹æ˜¯è¿™æ¬¡çš„<code>then</code>æ˜¯åœ¨<code>when</code>é‡Œé¢ï¼Œå› ä¸ºæŠ›å¼‚å¸¸ä¼šåœ¨<code>handler</code>ä¸ŠæŠ›ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å°†<code>then</code>çš„åˆ¤å®šæ”¾åœ¨<code>handler</code> ä¸Šã€‚è¿™é‡Œç”¨åˆ°äº†<code>Deno</code>çš„<code>assertThrowsAsync</code>æ¥æ•è·å¼‚å¸¸å¹¶åˆ¤å®šå¼‚å¸¸ã€‚</p>
<h5 id="given-2">given</h5>
<blockquote>
<ul>
<li><code>mock</code> <code>UserService</code>, ç»™ UserService çš„ <code>addUser</code>æ–¹æ³•æ‰“æ¡©ï¼Œå¹¶è¿”å›ç‰¹å®šçš„ç”¨æˆ·ç»“æ„ï¼›</li>
<li>æ–°å»ºæµ‹è¯•æœåŠ¡ï¼Œå¹¶å°† <code>UserController</code>æ³¨å†Œç»™ post æ¥å£ <code>/users</code>;</li>
</ul>
</blockquote>
<h5 id="when-2">when</h5>
<blockquote>
<ul>
<li>ç»™<code>body</code>ä¼ å…¥ç©ºå‚æ•°ï¼Œç”¨<code>fetch</code>è¯·æ±‚<code>http://127.0.0.1:9000/users</code>;</li>
</ul>
</blockquote>
<h5 id="then-2">then</h5>
<blockquote>
<ul>
<li><code>then</code>éƒ¨åˆ†å¤„äº<code>given</code>çš„è·¯ç”±å¤„ç†<code>handler</code>ä¸­ï¼Œå¯¹å¼‚å¸¸è¿›è¡Œæ•è·å¹¶åˆ¤å®šï¼Œæ¥ç€ä¸­æ–­æµ‹è¯•åº”ç”¨ï¼Œå°†æ‰“æ¡©çš„æ–¹æ³•æ¢å¤ã€‚</li>
</ul>
</blockquote>
<h5 id="è¿è¡Œæµ‹è¯•-1">è¿è¡Œæµ‹è¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make <span class="nb">test</span>
</span></span><span class="line"><span class="cl">deno <span class="nb">test</span> --allow-env --allow-net -L info
</span></span><span class="line"><span class="cl">Check file:///xxx/deno-restful-api-with-postgresql-tdd/.deno.test.ts
</span></span><span class="line"><span class="cl">running <span class="m">5</span> tests
</span></span><span class="line"><span class="cl"><span class="nb">test</span> should work ... ok <span class="o">(</span>5ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should return added user when add user ... ok (21ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no params given no params when add user ... ok (4ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no correct params given wrong params when add user ... ok (3ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> health check ... ok <span class="o">(</span>4ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">5</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out <span class="o">(</span>37ms<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="service">Service</h4>
<p><code>Service</code>æ˜¯æœåŠ¡å±‚ï¼Œé€šè¿‡ç»„åˆå…¶ä»–æœåŠ¡å’Œè°ƒç”¨åº•å±‚æ•°æ®æ¥å£å±‚æä¾›æœåŠ¡ï¼›å¯¹äºç”¨æˆ·æ·»åŠ ï¼Œå¯¹äºæ·»åŠ ç”¨æˆ·çš„<code>Service</code>, æˆ‘ä»¬åªéœ€è¦å°†ç”¨æˆ·å¯¹è±¡ä¼ é€’è¿‡æ¥ï¼Œç„¶åç”±<code>Repository</code>æ¥å¤„ç†ï¼›æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„<code>Todo</code>å¯¹åº”å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å½“ä¼ å…¥æœŸæœ›çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¯è¿”å›ç‰¹å®šæ•°æ®ç»“æ„çš„ç”¨æˆ·ä¿¡æ¯</p>
</blockquote>
<p>æ–°å»º<code>UserService.test.ts</code>ï¼Œ å¹¶å¯¼å…¥ç›¸å…³ä¾èµ–ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// tests/services/UserService.test.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">v4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">UserRepo</span> <span class="kr">from</span> <span class="s2">&#34;../../src/repositories/userRepo.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">UserService</span> <span class="kr">from</span> <span class="s2">&#34;../../src/services/UserService.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IUser</span> <span class="kr">from</span> <span class="s2">&#34;../../src/entity/User.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;UserService #addUser should return added user&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">parameter</span>: <span class="kt">IUser</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">username</span><span class="o">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">password</span><span class="o">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">registrationDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toISOString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">v4</span><span class="p">.</span><span class="nx">generate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mockedUser</span>: <span class="kt">IUser</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">parameter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">registrationDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">deleted</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">createUserStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">UserRepo</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">userRepo</span><span class="p">,</span> <span class="s2">&#34;create&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createUserStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedUser</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userService</span><span class="p">.</span><span class="nx">userRepo</span> <span class="o">=</span> <span class="nx">userRepo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="k">await</span> <span class="nx">userService</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">parameter</span><span class="p">),</span> <span class="nx">mockedUser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createUserStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç é€»è¾‘å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸éœ€è¦è§£é‡Šã€‚è¿è¡Œæµ‹è¯•è‚¯å®šä¼šå¤±è´¥ï¼Œä¸ºäº†è®©ä»£ç é€šè¿‡æµ‹è¯•ï¼Œç¼–å†™<code>UserService.ts</code>, åœ¨<code>UserService.ts</code>ä¸­è°ƒç”¨<code>Repository</code>çš„<code>create</code>æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œä¹Ÿéœ€è¦ç®€å•å®ç°<code>UserRepo</code>ï¼Œåªéœ€è¦æ·»åŠ <code>create</code>æ–¹æ³•å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/services/UserService.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">UserRepo</span> <span class="kr">from</span> <span class="s2">&#34;../repositories/userRepo.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IUser</span> <span class="kr">from</span> <span class="s2">&#34;../entity/User.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">UserService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">userRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">addUser</span><span class="p">(</span><span class="nx">user</span>: <span class="kt">IUser</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepo</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¿è¡Œæµ‹è¯•-2">è¿è¡Œæµ‹è¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make <span class="nb">test</span>
</span></span><span class="line"><span class="cl">deno <span class="nb">test</span> --allow-env --allow-net -L info
</span></span><span class="line"><span class="cl">Check file:///xxx/deno-restful-api-with-postgresql-tdd/.deno.test.ts
</span></span><span class="line"><span class="cl">running <span class="m">6</span> tests
</span></span><span class="line"><span class="cl"><span class="nb">test</span> should work ... ok <span class="o">(</span>5ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should return added user when add user ... ok (21ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no params given no params when add user ... ok (4ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no correct params given wrong params when add user ... ok (3ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> health check ... ok <span class="o">(</span>4ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserService <span class="c1">#addUser should return added user ... ok (1ms)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">6</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out <span class="o">(</span>38ms<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="repository">Repository</h4>
<p><code>Repository</code>é€šå¸¸å’Œæ•°æ®åº“äº¤äº’ï¼Œå°†ä¼ å…¥çš„æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼›å¯¹äºæ·»åŠ ç”¨æˆ·è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬çš„éœ€æ±‚å› è¯¥æ˜¯å°†ä¼ å…¥çš„ä¿¡æ¯ä»¥æ•°æ®åº“è¦æ±‚çš„æ ¼å¼å­˜å‚¨èµ·æ¥ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™<code>Service</code>; å› æ­¤ï¼Œ<code>Todo</code>å¤§è‡´å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li>å°†ä¼ å…¥çš„ç”¨æˆ·å­˜å…¥æ•°æ®äºå¹¶è¿”å›ç‰¹å®šæ•°æ®ç»“æ„çš„ä¿¡æ¯</li>
<li>å¦‚æœå‚æ•°ä¸­ç¼ºå°‘åŸºæœ¬å­—æ®µåˆ™æŠ›å¼‚å¸¸</li>
</ul>
</blockquote>
<p>æµ‹è¯•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// tests/repositories/UserRepo.test.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Stub</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">v4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assert</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertMatch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertThrowsAsync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">UserRepo</span> <span class="kr">from</span> <span class="s2">&#34;../../src/repositories/userRepo.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">client</span> <span class="kr">from</span> <span class="s2">&#34;../../src/Utils/client.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">IUser</span> <span class="kr">from</span> <span class="s2">&#34;../../src/entity/User.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">NotFoundException</span> <span class="kr">from</span> <span class="s2">&#34;../../src/exception/NotFoundException.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">InvalidedParamsException</span> <span class="kr">from</span> <span class="s2">&#34;../../src/exception/InvalidedParamsException.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Deno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;UserRepo #create should return mocked User given username&amp;password when create&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">queryStub</span>: <span class="kt">Stub</span><span class="p">&lt;</span><span class="nt">Client</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">stub</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s2">&#34;query&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mockedQueryResult</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rowCount</span>: <span class="kt">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queryStub</span><span class="p">.</span><span class="nx">returns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mockedQueryResult</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">parameter</span>: <span class="kt">IUser</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">username</span><span class="o">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">password</span><span class="o">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userRepo</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">createdUserResult</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepo</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">parameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">createdUserResult</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertEquals</span><span class="p">(</span><span class="nx">createdUserResult</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">parameter</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assert</span><span class="p">(</span><span class="nx">v4</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">createdUserResult</span><span class="p">.</span><span class="nx">id</span><span class="o">!</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assertMatch</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createdUserResult</span><span class="p">.</span><span class="nx">registrationDate</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="sr">/[\d]{4}-[\d]{2}-[\d]{2}T[\d]{2}:[\d]{2}:[\d]{2}\.[\d]{1,3}Z/</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">queryStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">test</span><span class="p">(</span><span class="s2">&#34;UserRepo #create should throw exception given no value for field when create&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">parameter</span>: <span class="kt">IUser</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">username</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">password</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">userRepo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserRepo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">assertThrowsAsync</span><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="nx">userRepo</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">parameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="nx">InvalidedParamsException</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;should supply valid username and password!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸º<code>Repository</code>å±‚è¦å’Œæ•°æ®åº“æ‰“äº¤é“ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå’Œæ•°æ®åº“æ“ä½œç›¸åº”çš„å¤„ç†å·¥å…·åº“ï¼›åœ¨æ­¤æˆ‘ä»¬æœŸæœ›é€šè¿‡ä½¿ç”¨<code>PostgreSql</code>è‡ªå·±çš„çš„<code>Client</code>æ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚</p>
<p>åœ¨ä¸Šé¢ç¬¬ä¸€ä¸ªæµ‹è¯•ä»£ç ä¸­ï¼Œ æˆ‘ä»¬<code>mock</code>äº†<code>Client</code>çš„<code>query</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›äº†é¢„å®šçš„æ•°æ®ã€‚æ¥ç€è°ƒç”¨<code>UserRepo</code>çš„<code>create</code>æ–¹æ³•ï¼Œåˆ¤æ–­è¿”å›æ•°æ®çš„æ•°æ®å­—æ®µå€¼ä¸æœŸæœ›å€¼æ˜¯å¦ä¸€è‡´ã€‚</p>
<p>è¿è¡Œæµ‹è¯•ä¾æ—§ä¼šå¤±è´¥ï¼Œæ¥ä¸‹æ¥ä»¥æœ€ç®€å•çš„æ–¹å¼å®ç°è®©æµ‹è¯•é€šè¿‡ã€‚</p>
<p>å¯¼å…¥<code>PostgreSql</code>ç›¸å…³çš„ä¾èµ–ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="p">{</span> <span class="nx">Client</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;https://deno.land/x/postgres/mod.ts&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŠå®šä¹‰æ•°æ®åº“è¿æ¥ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/config.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DB_HOST</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span> <span class="o">||</span> <span class="s2">&#34;localhost&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DB_USER</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span> <span class="o">||</span> <span class="s2">&#34;postgres&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DB_PASSWORD</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span> <span class="o">||</span> <span class="s2">&#34;0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DB_DATABASE</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">DB_DATABASE</span> <span class="o">||</span> <span class="s2">&#34;postgres&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DB_PORT</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">DB_PORT</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PORT</span><span class="p">)</span> <span class="o">:</span> <span class="mi">5432</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·å–æ•°æ®åº“è¿æ¥çš„<code>Client</code>å®ä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/Utils/client.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Client</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../../deps.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DB_HOST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DB_DATABASE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DB_PORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DB_USER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DB_PASSWORD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../config.ts&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">hostname</span>: <span class="kt">DB_HOST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">database</span>: <span class="kt">DB_DATABASE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">user</span>: <span class="kt">DB_USER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span>: <span class="kt">DB_PASSWORD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">port</span>: <span class="kt">DB_PORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">client</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•°æ®åº“åº”è¯¥åœ¨åº”ç”¨å¯åŠ¨æ—¶è¿æ¥ï¼Œæ‰€ä»¥åœ¨<code>index.ts</code>å¼•å…¥<code>client</code>å¹¶å»ºç«‹è¿æ¥å’Œç®¡ç†è¿æ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;æ•°æ®åº“é“¾æ¥æˆåŠŸï¼&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createApplication</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="k">await</span> <span class="nx">listenToServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="é‡æ–°å¯åŠ¨æµ‹è¯•">é‡æ–°å¯åŠ¨æµ‹è¯•</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make <span class="nb">test</span>
</span></span><span class="line"><span class="cl">deno <span class="nb">test</span> --allow-env --allow-net -L info
</span></span><span class="line"><span class="cl">Check file:///xxx/deno-restful-api-with-postgresql-tdd/.deno.test.ts
</span></span><span class="line"><span class="cl">running <span class="m">8</span> tests
</span></span><span class="line"><span class="cl"><span class="nb">test</span> should work ... ok <span class="o">(</span>2ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserRepo <span class="c1">#create should return mocked User given username&amp;password when create ... ok (1ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserRepo <span class="c1">#create should throw exception given no value for field when create ... ok (1ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should return added user when add user ... ok (14ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no params given no params when add user ... ok (4ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserController <span class="c1">#addUser should throw exception about no correct params given wrong params when add user ... ok (2ms)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> health check ... ok <span class="o">(</span>3ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> UserService <span class="c1">#addUser should return added user ... ok (1ms)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">8</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out <span class="o">(</span>28ms<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¯·æ±‚ä½“-1">è¯·æ±‚ä½“</h5>
<p>ç”±<code>RestClient</code>éªŒè¯è¯·æ±‚ï¼› ç°åœ¨å¯åŠ¨åº”ç”¨ï¼Œå‘é€å¦‚ä¸‹è¯·æ±‚ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// _resources/httpClient/addUser.http
</span></span><span class="line"><span class="cl">POST http://localhost:8000/api/v1/users HTTP/1.1
</span></span><span class="line"><span class="cl">Content-Type: application/x-www-form-urlencoded
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">name=foo&amp;password=123
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è¯·æ±‚ç»“æœ-1">è¯·æ±‚ç»“æœ</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HTTP/1.1 201 Created
</span></span><span class="line"><span class="cl">content-length: 149
</span></span><span class="line"><span class="cl">x-response-time: 34ms
</span></span><span class="line"><span class="cl">content-type: application/json; charset=utf-8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;success&#34;: true,
</span></span><span class="line"><span class="cl">  &#34;data&#34;: {
</span></span><span class="line"><span class="cl">    &#34;username&#34;: &#34;foo&#34;,
</span></span><span class="line"><span class="cl">    &#34;password&#34;: &#34;123&#34;,
</span></span><span class="line"><span class="cl">    &#34;id&#34;: &#34;7aea0bb7-e0bc-4f1f-a516-3a43f4e30fb6&#34;,
</span></span><span class="line"><span class="cl">    &#34;registrationDate&#34;: &#34;2020-07-27T14:11:24.140Z&#34;
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¼‚å¸¸æƒ…å†µå¯ä»¥è‡ªå·±åˆ¶é€ ï¼Œåœ¨æ­¤å°±ä¸æ¼”ç¤ºäº†ï¼Œè‡³æ­¤å®Œæˆç”¨æˆ·æ·»åŠ çš„æ¥å£ã€‚</p>
<h2 id="æ‰“åŒ…">æ‰“åŒ…</h2>
<p>æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ŒæˆæŸ¥è¯¢å•ä¸ªç”¨æˆ· (<code>GET</code>:<code>/users/:id</code>), æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ· (<code>GET</code>:<code>/users</code>) å’Œåˆ é™¤ (<code>DELETE</code>:<code>/users/:id</code>) ç­‰æ¥å£ï¼Œå¿«é€Ÿä¸”é«˜æ•ˆã€‚å½“æˆ‘ä»¬å®Œæˆæµ‹è¯•å’Œæ¥å£åï¼Œä½¿ç”¨<code>deno</code>çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªå·¥ç¨‹æ‰“åŒ…ä¸ºä¸€ä¸ª<code>.js</code>æ–‡ä»¶ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make bundle
</span></span><span class="line"><span class="cl">mkdir dist
</span></span><span class="line"><span class="cl">deno bundle src/index.ts dist/platform.js
</span></span><span class="line"><span class="cl">Bundle file:///xxx/deno-restful-api-with-postgresql-tdd/src/index.ts
</span></span><span class="line"><span class="cl">Emit <span class="s2">&#34;dist/platform.js&#34;</span> <span class="o">(</span>856.11 KB<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº<code>NodeJs</code>å¼€å‘çš„åç«¯åº”ç”¨ï¼Œå¯æ€•çš„<code>node_modules</code>ä¾èµ–åœ¨æ‰“åŒ…æ—¶ä¼šæ˜¯ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬çš„<code>Node</code>åç«¯åº”ç”¨éƒ½æ˜¯ç›´æ¥å°†ç¯å¢ƒå˜é‡æ›´æ–°ä¸€ä¸‹ï¼Œç„¶åå°†å…¶éƒ¨ç½²åœ¨ç”Ÿäº§ç¯å¢ƒï¼›
å¼€å‘è€…å†™çš„å·¥ç¨‹æ–‡ä»¶å¹¶æ²¡æœ‰å¤šå¤§ï¼Œè€Œåº”ç”¨ä¾èµ–çš„<code>node_modules</code>å¤§å¤šæ—¶å€™æ—¶å·¥ç¨‹æ–‡ä»¶çš„å‡ åå€ç”šè‡³å‡ ç™¾å€ã€‚ç„¶å<code>Deno</code>å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="å¯åŠ¨åº”ç”¨-1">å¯åŠ¨åº”ç”¨</h2>
<p>å¦‚æœ‰éœ€è¦å°†æ‰“åŒ…å¥½çš„<code>.js</code>æ‹·è´åˆ°ç›®æ ‡ç›®å½•ï¼Œåªè¦æœ‰<code>Deno</code>ç¯å¢ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å¯åŠ¨åº”ç”¨ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">â¯ make start
</span></span><span class="line"><span class="cl"><span class="nv">APP_PORT</span><span class="o">=</span><span class="m">1234</span> deno run --allow-net --allow-env ./dist/platform.js
</span></span><span class="line"><span class="cl">æ•°æ®åº“é“¾æ¥æˆåŠŸï¼
</span></span><span class="line"><span class="cl">Application started, and listen to 127.0.0.1:1234
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¹±ä¸­å–æ•´">ä¹±ä¸­å–æ•´</h2>
<p>é€šè¿‡å­¦ä¹ <code>Deno</code>, æœ‰äº†ä¸€äº›å¿ƒå¾—ä½“ä¼šï¼›</p>
<ul>
<li>å…¼å®¹æµè§ˆå™¨<code>API</code>,<code>Deno</code>å·¥ç¨‹å¯ä»¥ä½¿ç”¨<code>Javascript</code>å’Œ<code>Typescript</code>è¿›è¡Œç¼–ç¨‹ï¼Œå¤§å¤§é™ä½äº†è®¤çŸ¥å¤æ‚åº¦å’Œå­¦ä¹ éš¾åº¦ï¼›</li>
<li>å¦‚æœä½¿ç”¨<code>Typescript</code>å¼€å‘ï¼Œé‚£ä¹ˆä¼šé¿å…<code>åŠ¨æ€ä¸€æ—¶çˆ½ï¼Œé‡æ„ç«è‘¬åœº</code>çš„å°´å°¬å±€é¢ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨<code>Typescript</code>æ¥å†™åº”ç”¨ï¼›</li>
<li>å»ä¸­å¿ƒåŒ–ä»“åº“ï¼Œä»¥å•æ–‡ä»¶çš„å½¢å¼åˆ†å‘ï¼Œåœ¨åä½œå¼€å‘çš„æ—¶å€™ï¼Œä¸ºäº†ç»Ÿä¸€åº“ç‰ˆæœ¬ï¼Œå°±éœ€æ ¡éªŒä¾èµ–çš„ç‰ˆæœ¬ï¼Œ<code>Deno</code>æä¾›äº†ç”Ÿæˆ<code>lock.json</code>çš„å½¢å¼æ¥ä¿è¯ä¸åŒåä½œè€…ä¹‹é—´çš„ç‰ˆæœ¬ä¾èµ–ï¼›</li>
<li>&hellip;</li>
</ul>
<p>æœ€åæ„Ÿè°¢ <a href="https://yihaimen.github.io/" target="_blank" rel="noopener noreffer ">æµ·é—¨</a> å’Œ <a href="https://github.com/hylerrix" target="_blank" rel="noopener noreffer ">äº¦ä¹</a> çš„æ ¡å¯¹ä¸æŒ‡å¯¼ï¼›åœ¨ä»–ä»¬çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘é¡ºåˆ©å®Œæˆäº†è¿™ç¯‡åšå®¢ã€‚</p>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<ul>
<li>
<p><a href="https://github.com/guzhongren/deno-restful-api-with-postgresql-tdd" target="_blank" rel="noopener noreffer ">æºç ï¼šhttps://github.com/guzhongren/deno-restful-api-with-postgresql-tdd</a></p>
</li>
<li>
<p><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">åšå®¢ï¼šhttps://guzhongren.github.io/</a></p>
</li>
<li>
<p><a href="https://deno.land/" target="_blank" rel="noopener noreffer ">Denoland: https://deno.land/</a></p>
</li>
<li>
<p><a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreffer ">VS Code: https://code.visualstudio.com/</a></p>
</li>
<li>
<p><a href="https://www.docker.com/" target="_blank" rel="noopener noreffer ">Docker: https://www.docker.com/</a></p>
</li>
<li>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="noopener noreffer ">Typescript: https://www.typescriptlang.org/</a></p>
</li>
<li>
<p><a href="https://nodejs.org/" target="_blank" rel="noopener noreffer ">Node: https://nodejs.org/</a></p>
</li>
<li>
<p><a href="https://github.com/udibo/mock" target="_blank" rel="noopener noreffer ">mock: https://github.com/udibo/mock</a></p>
</li>
</ul>
<h2 id="å…è´£å£°æ˜">å…è´£å£°æ˜</h2>
<p>æœ¬æ–‡ä»…ä»£è¡¨ä¸ªäººè§‚ç‚¹ï¼Œä¸æœ¬äººæ‰€ä¾›èŒçš„å…¬å¸æ— ä»»ä½•å…³ç³»ã€‚</p>
<hr>
<p></p>
]]></description></item><item><title>åŸºäº Deno çš„ä¸€æ¬¡ TDD å®è·µ</title><link>https://guzhongren.github.io/2020/07/%E5%9F%BA%E4%BA%8Edeno%E7%9A%84%E4%B8%80%E6%AC%A1tdd%E5%AE%9E%E8%B7%B5/</link><pubDate>Sun, 05 Jul 2020 10:23:18 +0800</pubDate><author>è°·ä¸­ä»</author><guid>https://guzhongren.github.io/2020/07/%E5%9F%BA%E4%BA%8Edeno%E7%9A%84%E4%B8%80%E6%AC%A1tdd%E5%AE%9E%E8%B7%B5/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://images.unsplash.com/photo-1593918092889-a4cd49ee8081?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=1489&amp;q=80" referrerpolicy="no-referrer">
            </div><p>è§†é¢‘è®°å½•äº†æˆ‘åŸºäº<code>Deno</code> Web æ¡†æ¶ <code>oak</code> ä½¿ç”¨ <code>TDD</code>çš„æ–¹å¼å†™çš„ä¸€ä¸ªç®€å•çš„å·¥ç¨‹åŒ–çš„ demoã€‚</p>
<iframe src="//player.bilibili.com/player.html?aid=413678008&bvid=BV1uV41167Fo&cid=208888409&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width: 100%;min-height: 500px;> </iframe>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">1. åšå®¢ï¼šhttps://guzhongren.github.io/</a></li>
<li><a href="https://sm.ms/" target="_blank" rel="noopener noreffer ">2. å›¾åºŠï¼šhttps://sm.ms/</a></li>
<li><a href="https://www.bilibili.com" target="_blank" rel="noopener noreffer ">3.Bilibili</a></li>
</ul>
<h2 id="å…è´£å£°æ˜">å…è´£å£°æ˜</h2>
<p>æœ¬æ–‡ä»…ä»£è¡¨ä¸ªäººè§‚ç‚¹ï¼Œä¸æœ¬äººæ‰€ä¾›èŒçš„å…¬å¸æ— ä»»ä½•å…³ç³»ã€‚</p>
<hr>
<p></p>
]]></description></item><item><title>æ•´åˆèµ„æºä¸ºå…¶ä»–ç«¯æä¾›ç»Ÿä¸€èµ„æº</title><link>https://guzhongren.github.io/2020/05/%E6%95%B4%E5%90%88%E8%B5%84%E6%BA%90%E4%B8%BA%E5%85%B6%E4%BB%96%E7%AB%AF%E6%8F%90%E4%BE%9B%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90/</link><pubDate>Sat, 23 May 2020 18:29:22 +0800</pubDate><author>ByteWars</author><guid>https://guzhongren.github.io/2020/05/%E6%95%B4%E5%90%88%E8%B5%84%E6%BA%90%E4%B8%BA%E5%85%B6%E4%BB%96%E7%AB%AF%E6%8F%90%E4%BE%9B%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://i.loli.net/2020/05/10/67DtxyJqFRz2YZH.png" referrerpolicy="no-referrer">
            </div><h2 id="å¼•å­">å¼•å­</h2>
<p>æœ‰äº›æ—¶å€™ï¼Œè½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­æ²¡æœ‰å°†ç³»ç»ŸåŠŸèƒ½ï¼Œä¸”åˆ†å¼€ä»è€Œå°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œæˆ–è€…åœ¨è‡ªèº«ç³»ç»Ÿå¼€å‘è¿‡ç¨‹ä¸­æœ‰å¿…é¡»è¦ä¾èµ–çš„å¤–éƒ¨æœåŠ¡ï¼Œé‚£ä¹ˆå¯¹å¤–æä¾›æœåŠ¡çš„æ—¶å€™å°±å¾—è®©æ‰€æœ‰çš„å­æœåŠ¡éƒ½å¾—éšæ—¶å€™å‘½ï¼Œ
æ’åˆ—èµ·æ¥å°±åƒå¤ä»£æˆ˜åœºçš„å¯¹æˆ˜çŠ¶æ€ä¸€æ ·äº†ã€‚</p>
<p></p>
<h2 id="å­˜åœ¨çš„é—®é¢˜">å­˜åœ¨çš„é—®é¢˜</h2>
<p>å¯¹äºè¿™ç§æƒ…å†µå­˜åœ¨ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œä½œä¸ºè€æ¿æˆ–è€…ä¸šåŠ¡å¯¹æ¥æ–¹ï¼Œæˆ‘è¦é›†æˆå’Œä¹‹å‰ä¸€æ ·çš„ç³»ç»Ÿï¼Œæˆ‘è¦å¯¹æ¥è¿™ä¹ˆå¤šæ¥å£ä¹ˆï¼Ÿå¦‚æœå¯¹æ¥æ–¹çœ‹åˆ°è¿™ä¹ˆå¤šçš„ç³»ç»Ÿæ¥å£è¦å¯¹æ¥ï¼Œä»–è‚¯å®šå°±æ”¾å¼ƒæ²»ç–—äº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹å­˜åœ¨çš„é—®é¢˜ã€‚</p>
<ul>
<li>å¯¹æ¥ç³»ç»Ÿæ¥å£è¾ƒå¤šï¼Œè¿˜å¯èƒ½å¯¹æ¥å¾ˆå¤šä¸ªåŸŸå</li>
<li>ä½œä¸ºå¯¹æ¥æ–¹ï¼Œç³»ç»Ÿæ¥å£å‡ºäº†é—®é¢˜ï¼Œæˆ‘å¾—çœ‹æ˜¯å“ªä¸ªç³»ç»Ÿå‡ºé—®é¢˜äº†ï¼Œè¿˜å¾—å»æ‰¾å¯¹åº”çš„å¯¹æ¥æ–¹</li>
<li>ä¸åŒçš„æ¥å£ï¼Œå¯èƒ½å­˜åœ¨ä¸åŒçš„ç”©é”…è¡Œä¸º</li>
<li>ä¹±ï¼Œæ–°äººå¾ˆéš¾å¾ˆå¿«ä¸Šæ‰‹</li>
<li>å¤šåˆ™ä¹±ï¼Œä¹±åˆ™è¦èŠ±å¾ˆå¤šé’±</li>
</ul>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>å¯¹äºä¸Šé¢æåˆ°çš„å„ç§é—®é¢˜ï¼Œæˆ‘ä»¬æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<p>æœ€è¿‘ï¼Œå¾®æœåŠ¡çš„æ¦‚å¿µæ¯”è¾ƒæµè¡Œï¼Œ æˆ‘ä»¬æƒ³æƒ³ä¸€ä¸‹å‰ç«¯å¾®æœåŠ¡æ˜¯æ€ä¹ˆç»„åˆçš„ï¼Ÿæ˜¯ä¸æ˜¯å°†å¾ˆå¤šä¸ªå­é¡µé¢æœåŠ¡éƒ½é›†æˆåœ¨ä¸€ä¸ªä¸€é¢ä¸­ï¼Œæœ€ç»ˆè¿™ä¸ªé¡µé¢ä¸ºç”¨æˆ·æœåŠ¡ã€‚è®©è¿™ä¸ªé¡µé¢ä½œä¸ºå¯¹æ¥ç‚¹ã€‚ç»“åˆä¸Šé¢çš„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡å¦‚ä¸‹å›¾çš„æ–¹æ¡ˆï¼Œ æŠ½ç¦»ä¸€ä¸ªä¸­é—´å±‚ï¼Œæˆ‘ä»¬æš‚æ—¶å¯ä»¥ç§°ä¹‹ä¸º <code>Platform</code>ï¼Œ
è®©æ‰€æœ‰çš„èµ„æºéƒ½ä»<code>Platform</code>è¿›å’Œå‡ºï¼Œå°†è¦é›†æˆçš„å„ç§æœåŠ¡å±è”½åœ¨<code>Platform</code>åé¢ï¼Œå¯¹äºå¯¹æ¥æ–¹ï¼Œä»–æ°¸è¿œåªçŸ¥é“ä¸€ä¸ª<code>Platform</code>ï¼Œ è¿™æ ·é›†æˆèµ·æ¥å°±å¥½å¤šäº†ã€‚</p>
<p></p>
<h2 id="coding">Coding</h2>
<p>æ–¹æ¡ˆä¹Ÿæœ‰äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æ’¸èµ·è¢–å­åŠ æ²¹å¹²çš„æ—¶å€™äº†ã€‚</p>
<p>å› ä¸º <code>Platform</code> ä¼šæ˜¯ä¸€ä¸ªåç«¯çš„å·¥ç¨‹ï¼Œå…¶å¯¹å¤–æä¾›å„ç§æ¥å£å’Œèµ„æºï¼›æœ€è¿‘<code>Deno</code>æ¯”è¾ƒğŸ”¥ï¼Œä¸ºäº†å°è¯•<code>çœŸé¦™å®šå¾‹</code>ï¼Œ æˆ‘ä»¬å°±æ‹¿å®ƒæ¥å®è·µä¸€ä¸‹ã€‚</p>
<h3 id="ä¸šåŠ¡">ä¸šåŠ¡</h3>
<p>å¯¹äºåç«¯è¯·æ±‚å¦ä¸€ä¸ªåç«¯æ¥å£ï¼Œå°†è¯·æ±‚çš„ç»“æœå†è¿”å›ç»™è¯·æ±‚è€…ï¼Œè¿™ä¸ªå¾ˆå®¹æ˜“å®ç°ï¼Œ æˆ‘ä»¬å°±ä¸å®ç°äº†ï¼›é‚£ä¹ˆæˆ‘ä»¬æ¥åšä¸€ä¸ªä¸åŒçš„æ“ä½œã€‚</p>
<h4 id="ä¸šåŠ¡æµç¨‹">ä¸šåŠ¡æµç¨‹</h4>
<ul>
<li>æŸä¸ªåç«¯æä¾›å‰ç«¯èµ„æºï¼Œ è¿™ä¸ªèµ„æºæ˜¯ç”±è¿™ä¸ªåç«¯æœåŠ¡å›¢é˜Ÿç»´æŠ¤ï¼Œä¸”è¿™ä¸ªæœåŠ¡éœ€è¦åœ¨å‰ç«¯ä½¿ç”¨</li>
</ul>
<p>åœ¨æ­¤ï¼Œ æˆ‘ä»¬å°†è¿™ä¸ªåç«¯èµ„æºæš‚æ—¶æŠ½è±¡ä¸º<code>jquery.js</code>, æä¾› jquery.js æœåŠ¡çš„å›¢é˜Ÿå°±æ˜¯è¢«æˆ‘ä»¬ Platform å±è”½èµ·æ¥çš„æœåŠ¡å›¢é˜Ÿï¼Œ å¯¹æˆ‘ä»¬æœ¬æ¬¡å®è·µæ¥è¯´å°±æ˜¯æŸä¸€ä¸ªæä¾› Jquery çš„ CDN æœåŠ¡å•†ã€‚</p>
<p>å…·ä½“çš„ <a href="https://github.com/ByteWars/forwardJS" target="_blank" rel="noopener noreffer ">Code</a> åœ¨æ­¤ï¼Œå¦‚æœ‰éœ€è¦å¯éšæ—¶æŸ¥çœ‹ã€‚åœ¨å®ç°è¿‡ç¨‹ä¸­ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œ</p>
<p>èµ„æºè¯·æ±‚çš„å‰ç«¯é¡µé¢ä»£ç å¦‚ä¸‹ï¼Œ<strong>é‡ç‚¹å°±æ˜¯ <code>script</code>æ ‡ç­¾ä¸­<code>src</code>çš„è·å–æ˜¯ä¸€ä¸ª <code>GET</code>è¯·æ±‚ï¼</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1.0&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Document<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;http://localhost:8000/custom/domain/jquery.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ–¹æ¡ˆ-1">æ–¹æ¡ˆ 1</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Typescript" data-lang="Typescript"><span class="line"><span class="cl"><span class="c1">// handlers/fetchJquery.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">({</span> <span class="nx">response</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">response</span>: <span class="kt">Response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">jqueryUrl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§æ–¹æ¡ˆæ˜¯å°†èµ„æºçš„è¯·æ±‚è½¬å‘åˆ° jquery çš„èµ„æºæœåŠ¡åœ°å€ä¸Šï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨ 302 è·³è½¬åˆ°è¯¥åœ°å€ï¼Œè¿›è¡Œèµ„æºè·å–ã€‚</p>
<h5 id="æ–¹æ¡ˆ-2">æ–¹æ¡ˆ 2</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Typescript" data-lang="Typescript"><span class="line"><span class="cl"><span class="c1">// handlers/fetchJquery.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">getContent</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">({</span> <span class="nx">response</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">response</span>: <span class="kt">Response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetchResponse</span><span class="p">(</span><span class="nx">jqueryUrl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// services/fetchResource.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">url</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§æ–¹æ¡ˆæ˜¯å°†èµ„æºè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œç„¶åå°†èµ„æºå†è¿”å›ç»™å‰ç«¯ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å¯¹äºè¿™ä¸¤ç§æ–¹æ¡ˆï¼Œæ›´åŠ æ¨èç¬¬ä¸€ç§ï¼›ç¬¬ä¸€ç§æ–¹æ¡ˆå°†èµ„æºçš„è·¯å¾„è¿”å›ç»™å‰ç«¯ç„¶åç”±æµè§ˆå™¨åšè·³è½¬å¹¶å°†èµ„æºè¯·æ±‚å›æ¥ï¼Œ è€Œç¬¬äºŒç§éœ€è¦å°†èµ„æºè¯·æ±‚å›æ¥ï¼Œå¦‚æœè¯¥èµ„æºçš„è¯·æ±‚é‡æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå°±å¾—åšç¼“å­˜ï¼Œç›¸æ¯”äºç¬¬ä¸€ç§ï¼Œç¬¬äºŒç§ Platform åœ¨åæœŸç»´æŠ¤ä¹Ÿä¸å¥½ï¼Œè€Œä¸”å‹åŠ›ä¼šåœ¨ Platform å’Œè¢«å±è”½çš„æœåŠ¡é‚£é‡Œï¼Œå¤šäº†ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p>
<h2 id="å¼•ç”¨">å¼•ç”¨</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">1. åšå®¢ï¼šhttps://guzhongren.github.io/</a></li>
<li><a href="https://sm.ms/" target="_blank" rel="noopener noreffer ">2. å›¾åºŠï¼šhttps://sm.ms/</a></li>
<li><a href="https://github.com/ByteWars/forwardJS" target="_blank" rel="noopener noreffer ">3.ForwardJS</a></li>
<li><a href="https://mp.weixin.qq.com/s/J4A5EYL7Kk8cx_X7Kh36Iw" target="_blank" rel="noopener noreffer ">4. äº†ä¸èµ·çš„ Deno å®æˆ˜æ•™ç¨‹</a></li>
</ul>
<hr>
<p></p>
]]></description></item></channel></rss>