<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Action - 标签 - 谷中仁的博客</title><link>https://guzhongren.github.io/tags/action/</link><description>Action - 标签 - 谷中仁的博客</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><copyright>Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Thu, 20 Jan 2022 23:02:34 +0800</lastBuildDate><atom:link href="https://guzhongren.github.io/tags/action/" rel="self" type="application/rss+xml"/><item><title>构建更优的 GitHub Action 完成 Algolia 数据上传</title><link>https://guzhongren.github.io/2022/01/%E6%9E%84%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84github-action%E5%AE%8C%E6%88%90algolia%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0/</link><pubDate>Thu, 20 Jan 2022 23:02:34 +0800</pubDate><author>谷中仁</author><guid>https://guzhongren.github.io/2022/01/%E6%9E%84%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84github-action%E5%AE%8C%E6%88%90algolia%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://cdn.staticaly.com/gh/guzhongren/data-hosting@main/DevOps/Github-Action.6lpf9wwtga80.webp" referrerpolicy="no-referrer">
            </div><h2 id="场景">场景</h2>
<p>程序员喜欢写博客，大都喜欢自己 Host 一个自己的 Blog, 通常 Blog 会有一个全局的搜索功能，开源博客一般都会选择 <a href="https://lunrjs.com/" target="_blank" rel="noopener noreffer ">lunrjs</a> 或者 <a href="https://www.algolia.com/" target="_blank" rel="noopener noreffer ">algolia</a> 等。我的 Blog 是基于 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer ">Hugo</a> 构建的，使用的主题是 <a href="https://hugoloveit.com/" target="_blank" rel="noopener noreffer ">LoveIt</a>, 集成的是 algolia 的搜索方式。</p>
<p>对于存储在 algolia 上的数据，我是通过 GitHub Action：<a href="https://github.com/marketplace/actions/algolia-docsearch-indexer" target="_blank" rel="noopener noreffer ">Algolia Docsearch Indexer</a> 来上传的，之前使用是没有问题的。</p>
<h2 id="问题">问题</h2>
<p>突然有一天我要使用搜索功能，但是怎么也搜索不到我想搜索的内容，看了 GitHub 项目的构建状态，一切正常，然后登陆到 algolia 后台一看， 最后一次的数据更新是在 21 年 8 月； 然后打开最近的博客构建记录，看了执行如下 GitHub workflow 的 yaml 日志，大吃一惊：程序执行错误，但还是在最后给我们送了一个🚀，同样是写代码，你能忍？</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-yaml">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">darrenjennings/algolia-docsearch-action@master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">algolia_application_id</span><span class="p">:</span><span class="w"> </span><span class="l">${{secrets.ALGOLIA_APPLICATION_ID}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">algolia_api_key</span><span class="p">:</span><span class="w"> </span><span class="l">${{secrets.ALGOLIA_API_KEY}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;./public/index.json&#39;</span></span></span></code></pre></div></div>
<p>运行日志</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-log">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Run</span> <span class="n">darrenjennings</span><span class="o">/</span><span class="n">algolia</span><span class="o">-</span><span class="n">docsearch</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">master</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">a682564a13d76444749d3b720346ba2365371_9474ad</span> <span class="o">--</span><span class="n">label</span> <span class="mi">6</span><span class="n">a6825</span> <span class="o">--</span><span class="n">workdir</span> <span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">workspace</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_ALGOLIA_APPLICATION_ID</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_ALGOLIA_API_KEY</span> <span class="o">-</span><span class="n">e</span> <span class="n">INPUT_FILE</span> <span class="o">-</span><span class="n">e</span> <span class="n">HOME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_JOB</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_SHA</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REPOSITORY</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REPOSITORY_OWNER</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_ID</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_NUMBER</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RETENTION_DAYS</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_RUN_ATTEMPT</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTOR</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_WORKFLOW</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_HEAD_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_BASE_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_EVENT_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_SERVER_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_API_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_GRAPHQL_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_PROTECTED</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_REF_TYPE</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_WORKSPACE</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_EVENT_PATH</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION_REPOSITORY</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTION_REF</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_PATH</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ENV</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_OS</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_ARCH</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_NAME</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_TOOL_CACHE</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_TEMP</span> <span class="o">-</span><span class="n">e</span> <span class="n">RUNNER_WORKSPACE</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_RUNTIME_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_RUNTIME_TOKEN</span> <span class="o">-</span><span class="n">e</span> <span class="n">ACTIONS_CACHE_URL</span> <span class="o">-</span><span class="n">e</span> <span class="n">GITHUB_ACTIONS</span><span class="o">=</span><span class="bp">true</span> <span class="o">-</span><span class="n">e</span> <span class="n">CI</span><span class="o">=</span><span class="bp">true</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/var/run/docker.sock&#34;</span><span class="p">:</span><span class="s2">&#34;/var/run/docker.sock&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_github_home&#34;</span><span class="p">:</span><span class="s2">&#34;/github/home&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_github_workflow&#34;</span><span class="p">:</span><span class="s2">&#34;/github/workflow&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/_temp/_runner_file_commands&#34;</span><span class="p">:</span><span class="s2">&#34;/github/file_commands&#34;</span> <span class="o">-</span><span class="n">v</span> <span class="s2">&#34;/home/runner/work/blog/blog&#34;</span><span class="p">:</span><span class="s2">&#34;/github/workspace&#34;</span> <span class="mi">6</span><span class="n">a6825</span><span class="p">:</span><span class="mi">64</span><span class="n">a13d76444749d3b720346ba2365371</span>  <span class="s2">&#34;***&#34;</span> <span class="s2">&#34;***&#34;</span> <span class="s2">&#34;./public/index.json&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Cloning</span> <span class="n">into</span> <span class="s1">&#39;docsearch-scraper&#39;</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">pipenv</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">pipenv</span><span class="o">-</span><span class="mf">2021.11</span><span class="o">.</span><span class="mi">23</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">3.6</span> <span class="n">MB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">virtualenv</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">virtualenv</span><span class="o">-</span><span class="mf">20.10</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">5.6</span> <span class="n">MB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">pip</span><span class="o">&gt;=</span><span class="mf">18.0</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="n">from</span> <span class="n">pipenv</span><span class="p">)</span> <span class="p">(</span><span class="mf">21.2</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">setuptools</span><span class="o">&gt;=</span><span class="mf">36.2</span><span class="o">.</span><span class="mi">1</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="n">from</span> <span class="n">pipenv</span><span class="p">)</span> <span class="p">(</span><span class="mf">57.5</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="o">&gt;=</span><span class="mf">0.2</span><span class="o">.</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">virtualenv_clone</span><span class="o">-</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">6.6</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">certifi</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2021.10</span><span class="o">.</span><span class="mi">8</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">149</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="o">&gt;=</span><span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">importlib_resources</span><span class="o">-</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">28</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="o">&gt;=</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry_points_selectable</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">6.2</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">six</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">11</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="o">&gt;=</span><span class="mf">0.12</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">importlib_metadata</span><span class="o">-</span><span class="mf">4.8</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">17</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">filelock</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">3.2</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">filelock</span><span class="o">-</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">9.9</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">distlib</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">distlib</span><span class="o">-</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">4</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">461</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">platformdirs</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="o">&gt;=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">platformdirs</span><span class="o">-</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">14</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">zipp</span><span class="o">&gt;=</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">zipp</span><span class="o">-</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">5.3</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Collecting</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="o">&gt;=</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">Downloading</span> <span class="n">typing_extensions</span><span class="o">-</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">22</span> <span class="n">kB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">zipp</span><span class="p">,</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="p">,</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="p">,</span> <span class="n">six</span><span class="p">,</span> <span class="n">platformdirs</span><span class="p">,</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="p">,</span> <span class="n">filelock</span><span class="p">,</span> <span class="n">distlib</span><span class="p">,</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="p">,</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="p">,</span> <span class="n">virtualenv</span><span class="p">,</span> <span class="n">certifi</span><span class="p">,</span> <span class="n">pipenv</span>
</span></span><span class="line"><span class="cl"><span class="n">WARNING</span><span class="p">:</span> <span class="n">Running</span> <span class="n">pip</span> <span class="n">as</span> <span class="n">the</span> <span class="s1">&#39;root&#39;</span> <span class="n">user</span> <span class="n">can</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">broken</span> <span class="n">permissions</span> <span class="ow">and</span> <span class="n">conflicting</span> <span class="n">behaviour</span> <span class="n">with</span> <span class="n">the</span> <span class="n">system</span> <span class="n">package</span> <span class="n">manager</span><span class="o">.</span> <span class="n">It</span> <span class="n">is</span> <span class="n">recommended</span> <span class="n">to</span> <span class="n">use</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">environment</span> <span class="n">instead</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pip</span><span class="o">.</span><span class="n">pypa</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">warnings</span><span class="o">/</span><span class="n">venv</span>
</span></span><span class="line"><span class="cl"><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">backports</span><span class="o">.</span><span class="n">entry</span><span class="o">-</span><span class="n">points</span><span class="o">-</span><span class="n">selectable</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2021.10</span><span class="o">.</span><span class="mi">8</span> <span class="n">distlib</span><span class="o">-</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">4</span> <span class="n">filelock</span><span class="o">-</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">1</span> <span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="o">-</span><span class="mf">4.8</span><span class="o">.</span><span class="mi">3</span> <span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="o">-</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span> <span class="n">pipenv</span><span class="o">-</span><span class="mf">2021.11</span><span class="o">.</span><span class="mi">23</span> <span class="n">platformdirs</span><span class="o">-</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">0</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span><span class="o">-</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">1</span> <span class="n">virtualenv</span><span class="o">-</span><span class="mf">20.10</span><span class="o">.</span><span class="mi">0</span> <span class="n">virtualenv</span><span class="o">-</span><span class="n">clone</span><span class="o">-</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">7</span> <span class="n">zipp</span><span class="o">-</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">WARNING</span><span class="p">:</span> <span class="n">You</span> <span class="n">are</span> <span class="n">using</span> <span class="n">pip</span> <span class="n">version</span> <span class="mf">21.2</span><span class="o">.</span><span class="mi">4</span><span class="p">;</span> <span class="n">however</span><span class="p">,</span> <span class="n">version</span> <span class="mf">21.3</span><span class="o">.</span><span class="mi">1</span> <span class="n">is</span> <span class="n">available</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="n">should</span> <span class="n">consider</span> <span class="n">upgrading</span> <span class="n">via</span> <span class="n">the</span> <span class="s1">&#39;/usr/local/bin/python -m pip install --upgrade pip&#39;</span> <span class="n">command</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Installing</span> <span class="n">dependencies</span> <span class="n">from</span> <span class="n">Pipfile</span><span class="o">.</span><span class="n">lock</span> <span class="p">(</span><span class="n">aabb41</span><span class="p">)</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;docsearch&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">5</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/src/index.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">161</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/src/commands/run_config.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">21</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">run_config</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/../scraper/src/index.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">33</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_config</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="ne">File</span> <span class="s2">&#34;/github/workspace/docsearch-scraper/cli/../scraper/src/config/config_loader.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">72</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl"><span class="n">AttributeError</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span> <span class="n">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;items&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">🚀</span> <span class="n">Successfully</span> <span class="n">indexed</span> <span class="ow">and</span> <span class="n">uploaded</span> <span class="n">the</span> <span class="n">results</span> <span class="n">to</span> <span class="n">Algolia</span></span></span></code></pre></div></div>
<p>面对一个磨洋工的工具，作为程序员的我们肯定不能忍。
打开 GitHub 上这个 Action 的 <a href="https://github.com/darrenjennings/algolia-docsearch-action" target="_blank" rel="noopener noreffer ">源码</a>, 根据对 Action 构建的了解和现有代码，作者使用的是 Python 和 algolia 自己在 GitHub 上开源的 <a href="https://github.com/algolia/docsearch-scraper.git" target="_blank" rel="noopener noreffer ">工具</a>, 然后执行一个  Python 脚本上传文件到 algolia 的；根据以往经验，由 Python 构建的项目镜像一般都比较大，在本地测试了一下，果不其然的大。</p>
<h3 id="面临的问题">面临的问题</h3>
<ul>
<li>工具损坏</li>
<li>镜像体积大</li>
</ul>
<h2 id="方案-spike">方案 Spike</h2>
<table>
  <thead>
      <tr>
          <th>Item</th>
          <th>Option1 使用 algolia 自己的 Restful 接口</th>
          <th>Option 2 algolia SDK</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>描述</td>
          <td>使用 algolia 自己的 Restful 接口实现上传</td>
          <td>使用其官方提供的 SDK 编写代码来集成</td>
      </tr>
      <tr>
          <td>是否推荐</td>
          <td>No</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>实现难度</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
      <tr>
          <td>优点</td>
          <td>流程可控</td>
          <td>简单直接，无需担心错误情况的处理</td>
      </tr>
      <tr>
          <td>缺点</td>
          <td>需要写更多的代码来控制整个流程</td>
          <td>整个上传过程不可控</td>
      </tr>
      <tr>
          <td>安全问题</td>
          <td>No</td>
          <td>No</td>
      </tr>
      <tr>
          <td>相对难度</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
      <tr>
          <td>相对成本</td>
          <td>Middle</td>
          <td>Low</td>
      </tr>
  </tbody>
</table>
<p>综上分析，使用 Option2 SDK 的方案更佳。</p>
<h2 id="执行方案">执行方案</h2>
<p>新建 GitHub Action 项目，我们使用 Dockerfile 的方式构建上传索引的方案；</p>
<ul>
<li>新建 entrypoint.sh 并写入如下代码，脚本执行需要传入如下几个变量：</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Required</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>FILE_PATH</td>
          <td>要上传的文件路径</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>ALGOLIA_APPLICATION_ID</td>
          <td>Algolia 平台的应用 Id</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>ADMIN_API_KEY</td>
          <td>Algolia 上传所用的 API Key</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>INDEX_NAME</td>
          <td>在 Algolia 上你所创建的索引名</td>
          <td>Yes</td>
      </tr>
  </tbody>
</table>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -eu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">npm install -g @algolia/cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">algolia import -s <span class="nv">$FILE_PATH</span> -a <span class="nv">$APPLICATION_ID</span> -k <span class="nv">$ADMIN_API_KEY</span> -n <span class="nv">$INDEX_NAME</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;0&#34;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;😢 Failed to upload your data to Algolia, PLZ report an issue, thx!&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;🚀 Successfully uploaded!&#34;</span></span></span></code></pre></div></div>
<ul>
<li>新建 Dockerfile 并写入如下代码，在此我们使用最小化的 Node 镜像 <code>node:lts-alpine</code></li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-dcokerfile">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM node:lts-alpine
</span></span><span class="line"><span class="cl">COPY entrypoint.sh /entrypoint.sh
</span></span><span class="line"><span class="cl">ENTRYPOINT [&#34;/entrypoint.sh&#34;]</span></span></code></pre></div></div>
<ul>
<li>更新 README, 完善使用文档。</li>
</ul>
<p>详细代码请参考 <a href="https://github.com/guzhongren/algolia-docsearch-upload-action/blob/main/Dockerfile" target="_blank" rel="noopener noreffer ">algolia-docsearch-upload-action</a>。</p>
<h2 id="验证结果">验证结果</h2>
<p>在完成 Action 并将其集成到 Pipeline 上之后，成功运行，数据可成功上传到 Algolia 平台上，并且博客的右上角的搜索功能可以成功搜索到最新的文章，说明我们的 Action 是可以完成我们的需求的。</p>
<h3 id="运行效率比较">运行效率比较</h3>
<p>没有对比就没有伤害。下面对我自己写的 Action 和之前集成过的 Action 在<code>镜像大小</code>和<code>执行效率</code>方面进行对比。</p>
<div class="echarts" id="id-1" style="width: 100%; height: 30rem;"></div>
<h3 id="镜像大小比较">镜像大小比较</h3>
<div class="echarts" id="id-2" style="width: 100%; height: 30rem;"></div>
<h2 id="引用">引用</h2>
<ul>
<li><a href="https://guzhongren.github.io/" target="_blank" rel="noopener noreffer ">博客：https://guzhongren.github.io/</a></li>
<li><a href="https://github.com/marketplace/actions/algolia-docsearch-indexer" target="_blank" rel="noopener noreffer ">Algolia Docsearch Indexer: https://github.com/marketplace/actions/algolia-docsearch-indexer</a></li>
<li><a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreffer ">GitHub Action: https://docs.github.com/en/actions</a></li>
</ul>
<h2 id="免责声明">免责声明</h2>
<p>本文仅代表个人观点，与本人所供职的公司无任何关系。</p>
<hr>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: f2fe1394e4ab9297ed69ff73ac32e9ac1375f01c2102183b509bf9379a5995d6</p>
</blockquote>
<h2 id="赞助">赞助</h2>
<p></p>
<blockquote>
<p><a href="https://emn178.github.io/online-tools/sha256_checksum.html" target="_blank" rel="noopener noreffer ">SHA256</a> checksum: 964978ecd2059064abe542e51dc02e204d3ee2e6c320ca68e2b1399ce0c6953c</p>
</blockquote>
<blockquote>
<p>使用此 <a href="https://guzhongren.github.io/images/pay/payforguzhongren.svg.sig" target="_blank" rel="noopener noreffer ">文件</a> 进行校验： <code>gpg --verify PayForGuzhongren.svg.sig</code></p>
</blockquote>
]]></description></item></channel></rss>