<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Container Image Scanner - Trivy - 谷中仁的博客</title><meta name=Description content="Container Image Scanner"><meta property="og:url" content="https://guzhongren.github.io/2021/09/container-image-scanner-trivy/">
<meta property="og:site_name" content="谷中仁的博客"><meta property="og:title" content="Container Image Scanner - Trivy"><meta property="og:description" content="Container Image Scanner"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-26T21:09:25+08:00"><meta property="article:modified_time" content="2025-08-04T16:04:16+08:00"><meta property="article:tag" content="Trivy"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Pipeline"><meta property="og:image" content="https://guzhongren.github.io/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guzhongren.github.io/"><meta name=twitter:title content="Container Image Scanner - Trivy"><meta name=twitter:description content="Container Image Scanner"><meta name=application-name content="谷中仁的博客"><meta name=apple-mobile-web-app-title content="谷中仁的博客"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/><link rel=prev href=https://guzhongren.github.io/2021/08/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BC%9A%E8%AE%AE/><link rel=next href=https://guzhongren.github.io/2021/10/container-image-scanner-trivy/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Container Image Scanner - Trivy","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/guzhongren.github.io\/2021\/09\/container-image-scanner-trivy\/"},"image":["https:\/\/guzhongren.github.io\/images\/avatar.png"],"genre":"posts","keywords":"Trivy, DevOps, Pipeline","wordcount":3339,"url":"https:\/\/guzhongren.github.io\/2021\/09\/container-image-scanner-trivy\/","datePublished":"2021-09-26T21:09:25+08:00","dateModified":"2025-08-04T16:04:16+08:00","license":"Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"guzhongren","logo":"https:\/\/guzhongren.github.io\/logo.png"},"author":{"@type":"Person","name":"谷中仁"},"description":"Container Image Scanner"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=谷中仁的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/avatar.svg data-srcset="/images/avatar.svg, /images/avatar.svg 1.5x, /images/avatar.svg 2x" data-sizes=auto alt=/images/avatar.svg title=/images/avatar.svg>谷中仁的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/ title=Tags>Tags </a><a class=menu-item href=/categories/ title=Categories>Categories </a><a class=menu-item href=/slides/ title=Slides>Slides </a><a class=menu-item href="https://www.figma.com/file/7EzjLtMRXKcaJrGEmudLwC/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1?node-id=0%3A1" title=知识图谱 rel="noopener noreffer" target=_blank>知识图谱 </a><a class=menu-item href=/about/ title=关于>关于 </a><a class=menu-item href=https://github.com/guzhongren title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> GitHub </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=谷中仁的博客><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/avatar.svg data-srcset="/images/avatar.svg, /images/avatar.svg 1.5x, /images/avatar.svg 2x" data-sizes=auto alt=/images/avatar.svg title=/images/avatar.svg>谷中仁的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title=Tags>Tags</a><a class=menu-item href=/categories/ title=Categories>Categories</a><a class=menu-item href=/slides/ title=Slides>Slides</a><a class=menu-item href="https://www.figma.com/file/7EzjLtMRXKcaJrGEmudLwC/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1?node-id=0%3A1" title=知识图谱 rel="noopener noreffer" target=_blank>知识图谱</a><a class=menu-item href=/about/ title=关于>关于</a><a class=menu-item href=https://github.com/guzhongren title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i>GitHub</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Container Image Scanner - Trivy</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://guzhongren.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>谷中仁</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/devops/><i class="far fa-folder fa-fw" aria-hidden=true></i>DevOps</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-09-26>2021-09-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 3339 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png data-srcset="https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png, https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png 1.5x, https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png title="Container Image Scanner"></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#摘要>摘要</a></li><li><a href=#基于容器的应用程序的安全痛点>基于容器的应用程序的安全痛点</a></li><li><a href=#保持容器镜像安全的价值>保持容器镜像安全的价值</a><ul><li><a href=#保护客户的财产property和声誉reputation>保护客户的财产（Property）和声誉（Reputation）</a></li><li><a href=#打造受人尊敬的品牌branding>打造受人尊敬的品牌（Branding）</a></li></ul></li><li><a href=#保持容器镜像安全的-2-个最佳方案>保持容器镜像安全的 2 个最佳方案</a><ul><li><a href=#方案-1-在镜像注册表中定期扫描>方案 1： 在镜像注册表中定期扫描</a></li><li><a href=#方案-2将扫描工具集成到-pipeline-中>方案 2：将扫描工具集成到 Pipeline 中</a></li></ul></li><li><a href=#容器安全扫描工具对比>容器安全扫描工具对比</a></li><li><a href=#trivy-在-thoughtworks-雷达-23-期中>Trivy 在 Thoughtworks 雷达 23 期中</a></li><li><a href=#trivy-的工作原理>Trivy 的工作原理</a></li><li><a href=#实践-trivy>实践 Trivy</a><ul><li><a href=#pipeline>Pipeline</a></li><li><a href=#trivy-的使用方法>Trivy 的使用方法</a></li><li><a href=#demo>Demo</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><h2 id=摘要>摘要</h2><p>在现代软件开发中， 我们会使用一些公共镜像作为基础镜像来快速构建我们的应用镜像，并将其部署到生产环境中。</p><p>随着越来越多的应用程序被容器化，容器安全也随之变得越来越重要。在项目的 Pipeline 中， 我们可以使用漏洞扫描器（Vulnerability Scanners）进行扫描并提前获得反馈，实现 “<strong>安全左移</strong>” ，也可以更好的实践敏捷。</p><h2 id=基于容器的应用程序的安全痛点>基于容器的应用程序的安全痛点</h2><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png alt=基于容器的应用程序的安全痛点></p><p>现在，我们使用先进的技术来构建我们的应用程序，如 NodeJS、 Java 和 Kotlin 等，然后将代码库存储在托管的 Git 平台上，如 GitHub、Gitlab 等。代码库由我们的业务代码和依赖关系组成；对于依赖项，我们可以使用专业的扫描工具来确保安全，比如 NodeJS 的 npm audit , GitHub 的 Dependabot；至于我们的业务代码，可以使用其他的一些安全工具可以扫描，比如 <a href=https://www.sonarqube.org/>SoneQube</a><sup>[1]</sup>
等。</p><p>因此，对于依赖（ Dependencies）和我们的业务代码，这些都在我们的控制之下，我们可以确保应用程序的安全性，并且在 Pipeline 上获得快速反馈；同时在我们将应用程序部署到生产环境之前可以通过使用各种工具建立信心。但是，通常情况下我们的应用程序运行的系统环境是不受我们控制的，可能存在潜在的安全漏洞。在这我们可以换位思考一下，如果我们不能保证我们的应用程序运行的系统的环境安全，就会导致各种各样意想不到的问题，如黑客攻击、用户信息泄露、财产损失，更会对公司的声誉造成损害。所以，确保我们产出物（Artifact）的安全是很重要的。</p><h2 id=保持容器镜像安全的价值>保持容器镜像安全的价值</h2><h3 id=保护客户的财产property和声誉reputation>保护客户的财产（Property）和声誉（Reputation）</h3><p>我们为公司或客户提供专业的服务，所以我们必须确保每一行代码都是可靠和安全的。因为代码就是公司或者客户的财产和名誉。作为开发者，只要保证代码及应用程序的环境的安全性，公司或者客户就能获得最大的效益。声誉即价值。</p><h3 id=打造受人尊敬的品牌branding>打造受人尊敬的品牌（Branding）</h3><p>我们的工作就是让我们的公司或客户成功。只有公司或客户成功，我们才能成功。因此，我们不仅要实现业务价值，还需要保护了产品的安全。用户使用安全的产品或者服务得到更大的价值，公司或者客户的品牌效应就会扩大，从而带来更大的价值。品牌及价值。</p><h2 id=保持容器镜像安全的-2-个最佳方案>保持容器镜像安全的 2 个最佳方案</h2><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2050.1czb512thukg.png alt="保持容器镜像安全的 2 个最佳方案"></p><h3 id=方案-1-在镜像注册表中定期扫描>方案 1： 在镜像注册表中定期扫描</h3><p>通过这种方式，我们需要为镜像注册表添加一个安全扫描程序，扫描程序可以是一个定时任务（Cron Job） 作业，也可以是由特定的人触发的可执行操作。</p><p>如果是一个定时任务，它将在特定时刻由定时任务自动触发。例如，Docker Hub 会在特定的时间扫描他们的官方注册表，当有任何漏洞被扫描出来时，它会向镜像维护者发送报警信息。</p><h3 id=方案-2将扫描工具集成到-pipeline-中>方案 2：将扫描工具集成到 Pipeline 中</h3><p>另一种方法是在 Pipeline 上对镜像产物进行扫描，这样更加简单高效。当我们将代码推送到代码存储库时， Pipeline 将自动执行扫描镜像的命令。因为 Pipeline 每次都是无差别地执行，所以我们可以发现任何安全问题并及时报警修复。</p><p>现在，越来越多的团队或公司使用敏捷来开发他们的项目。如果我们能够尽早地发现任何安全问题或者漏洞，我们就可以在产品发布之前降低产品的安全风险。 Pipeline 是确保每一行代码和基础运行环境的安全性是的最好方法之一，因为它可以在提交代码时自动执行。</p><h2 id=容器安全扫描工具对比>容器安全扫描工具对比</h2><p>针对上述解决方案，我们调查了 <a href=https://github.com/aquasecurity/trivy>Trivy</a><sup>[2]</sup>
、<a href=https://github.com/quay/clair>claire</a><sup>[3]</sup>
、<a href=https://github.com/anchore/anchore-engine>Anchore Engine</a><sup>[4]</sup>
、<a href=https://github.com/quay/quay>Quay</a><sup>[5]</sup>
、<a href=https://hub.docker.com/>Docker hub</a><sup>[6]</sup>
和 <a href=https://cloud.google.com/container-registry>GCR</a><sup>[7]</sup>
等几种扫描工具，从不同维度进行对比。</p><table><thead><tr><th style=text-align:left>Scanner</th><th style=text-align:left>OS packages</th><th style=text-align:left>Application dependencies</th><th style=text-align:left>Easy to use</th><th style=text-align:left>Accuracy</th><th style=text-align:left>Suitable for CI</th><th style=text-align:left>Suitable for Solution</th></tr></thead><tbody><tr><td style=text-align:left>Trivy</td><td style=text-align:left>✅</td><td style=text-align:left>✅</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>2</td></tr><tr><td style=text-align:left>Clair</td><td style=text-align:left>✅</td><td style=text-align:left>❌</td><td style=text-align:left>⭐</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>2</td></tr><tr><td style=text-align:left>Anchore Engine</td><td style=text-align:left>✅</td><td style=text-align:left>✅</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>2</td></tr><tr><td style=text-align:left>Quay</td><td style=text-align:left>✅</td><td style=text-align:left>❌</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>❌</td><td style=text-align:left>1</td></tr><tr><td style=text-align:left>Docker Hub</td><td style=text-align:left>✅</td><td style=text-align:left>❌</td><td style=text-align:left>⭐⭐⭐</td><td style=text-align:left>⭐</td><td style=text-align:left>❌</td><td style=text-align:left>1</td></tr><tr><td style=text-align:left>GCR</td><td style=text-align:left>✅</td><td style=text-align:left>❌</td><td style=text-align:left>⭐ ⭐ ⭐</td><td style=text-align:left>⭐ ⭐</td><td style=text-align:left>❌</td><td style=text-align:left>1</td></tr></tbody></table><p>首先，我们可以将这些扫描工具按照其执行的环境简单分类； 因为 Docker Hub、GCR 和 Quay 是需要在服务端也就是容器注册中心运行的， 所以适合方案 1； Trivy、Clair 和 Anchor Engine 可以在 Pipeline 上工作，所以适合解决方案 2。</p><p>对于第一个维度：OS Package，这些所有的扫描工具都可以做到，但是对于第二个维度：Application dependencies，只有 Trivy 和 Anchore Engine 可以做到，对于第五个维度：Suitable for CI, 只有前三个符合条件。</p><p>对于漏洞数据库的更新，Clair 会定期从一组配置的源中获取漏洞元数据库（Vulnerability Database），并将数据存储在其数据库中，只要不获取最新的漏洞元数据，每次执行都用之前的漏洞数据库，漏洞数据库的时效性有点差。 Trivy 和 Anchore Engine 则是每次运行都将下载最新的漏洞数据库并将其缓存在本地文件中，当扫描工具再次运行时，它将检查并更新数据库以保持数据库为最新状态。</p><p>同时，对于 Trivy、Clair 和 Anchore Engine，这三者的社区非常活跃，所以我们不能用没有人来帮你解决你的问题来评判； 而且作为一种工具，它必须易于使用并且有良好的文档可供参考。经过调研，发现 Trivy 的文档非常详细，非常友好， 而且 Trivy 的使用方式更加友好，比如我们可以过滤掉（.trivyignore）你指定的漏洞，对于最新发现的漏洞，官方没有给出修复版本，这时候我们就可以忽略这个漏洞继续构建，但 Anchore Engine 做不到。</p><p>2020 年 3 月 16 日，领先的云原生应用和基础设施安全平台供应商 Aqua Security 宣布，其开源的 Trivy 漏洞扫描器将作为一个集成选项添加到其使用的云原生平台、CNCF 的 Harbor 注册表和 Mirantis Docker Enterprise 中。你可以在这里找到这篇文章。</p><h2 id=trivy-在-thoughtworks-雷达-23-期中>Trivy 在 Thoughtworks 雷达 23 期中</h2><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/trivy-tw-radar.2543ysqo6wf4.png alt="Trivy in TW tech radar"></p><p>Thoughtworks 技术雷达以准反应技术趋势而闻名；在最新的技术雷达中，Thoughtworks 将 Trivy 引入了置于 <strong>Adopt</strong>，说明 Trivy 是有用的、有价值的和可行的。</p><h2 id=trivy-的工作原理>Trivy 的工作原理</h2><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2051.4icjkydqu3s0.png alt="Inner working of Trivy"></p><p>在我们使用 Trivy 之前，我们需要知道 Trivy 内部是如何运作的。如上图所示，有两个步骤；首先，我们运行 Trivy 命令，Trivy 将从 <a href=https://nvd.nist.gov>NVD</a><sup>[8]</sup>
网站下载漏洞数据库到本地机器。然后， Trivy 利用漏洞数据扫描你的镜像的每一层（Layer）。</p><h2 id=实践-trivy>实践 Trivy</h2><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/trivy-in-pipeline.6ksfsma323c0.png alt="trivy in pipeline"></p><h3 id=pipeline>Pipeline</h3><p>现在我们已经知道 Trivy 是如何工作的，我们可以将它集成到我们的 Pipeline 中；首先，将代码构建到 Docker 镜像中，接下来，Trivy 会扫描上一步构建的 Docker 镜像； 如果没有漏洞，镜像会被推送到镜像注册中心并部署到 Test 或者 UAT 环境； 如果存在漏洞，Pipeline 会被 Trivy 的命令行打断退出，这时候你就需要修复漏洞以使 Pipeline 变绿通过。</p><h3 id=trivy-的使用方法>Trivy 的使用方法</h3><p>在编写代码进行集成之前，我们必须知道如何使用 Trivy，Trivy 是一个二进制应用程序，所以我们可以在命令行中使用它。同时，Trivy 提供了它的 Docker 镜像，所以我们可以很容易地在 Pipeline 上设置和使用。命令如下，对于这个命令，我们需要重点说明一些参数。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-shell"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ docker run --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v /var/run/docker.sock:/var/run/docker.sock <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  aquasec/trivy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  image <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exit-code <span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --ignore-unfixed <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --severity HIGH,CRITICAL <span class=si>${</span><span class=nv>YOUR_IMAGE</span><span class=si>}</span></span></span></code></pre></div></div><ul><li>-v /var/run/docker.sock:/var/run/docker.sock 如果想扫描本地主机上的镜像，需要挂载 docker.sock</li><li>&ndash;ignore-unfixed 忽略未修复的漏洞问题；如果存在未修复的漏洞，Trivy 将忽略这些漏洞</li><li>&ndash;severity 设置要扫描的漏洞级别</li><li>&ndash;exit-code 发现漏洞时 Trivy 的退出状态（默认值：0)； 在 Pipeline 中，如果将该值设置为 1，且有漏洞被发现，则 Pipeline 将退出，而不会继续运行。如果将其设置为 0，则 Pipeline 将继续运行，但会报告结果。所以，如果你想在发现漏洞后阻止 Pipeline 继续执行，可以设置它为 1。</li></ul><p>想了解更多关于参数和使用方法的信息，请访问 Trivy 的官方网站：<a href=https://github.com/aquasecurity/trivy>https://github.com/aquasecurity/trivy</a><sup>[2]</sup>
。</p><h3 id=demo>Demo</h3><p>下面是一个 Demo，展示了 Trivy 如何打断 Pipeline 的执行 ，以及当我们修复问题后又发生什么。该项目将构建一个 Buildkite Dashboard（Buildkite 是一个 CI/CD 平台），它将过滤出你指定的组织下的项目的构建信息。这里我们使用 GitHub Actions 来构建这个应用程序，并在 Pipeline 中集成 Trivy，代码如下：</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-yml"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Trivy scanner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      docker run --rm \
</span></span></span><span class=line><span class=cl><span class=sd>      -v /var/run/docker.sock:/var/run/docker.sock \
</span></span></span><span class=line><span class=cl><span class=sd>      aquasec/trivy image \
</span></span></span><span class=line><span class=cl><span class=sd>      --severity HIGH,CRITICAL \
</span></span></span><span class=line><span class=cl><span class=sd>      --exit-code 1 \
</span></span></span><span class=line><span class=cl><span class=sd>      dashboard:${{ github.sha }}</span><span class=w>      </span></span></span></code></pre></div></div><p>在这个 Job 中，我们使用 <a href=https://hub.docker.com/_/nginx>Nignx:1.18</a><sup>[9]</sup>
作为基础镜像来构建应用程序镜像。可以看到由于存在一些漏洞，本次构建失败了。</p><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/trivy-dashboard-failed.4bffhau2xvk0.png alt="Trivy Dashboard Failed"></p><p>现在，我们必须解决这个问题来达到持续交付目的。这里有两个步骤要做，首先，我们应该使用最新的 Nginx 镜像作为基础镜像；其次，我们可以忽略未修复的漏洞，因为我们可能无法在系统级别修复某些最新的漏洞。你可以通过如下链接查看修复该问题的代码更改；
<a href=https://github.com/guzhongren/Buildkite-Dashboard/commit/90182b9b3770aeb28a6e566208334dd0c6f8f725#annotation_843974303>https://github.com/guzhongren/Buildkite-Dashboard/commit/90182b9b3770aeb28a6e566208334dd0c6f8f725#annotation_843974303</a><sup>[10]</sup></p><p><img src=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/trivy-dashboard-successfully.28w37b5otts0.png alt="Trivy Dashboard Successfully"></p><h2 id=总结>总结</h2><p>无论你在哪里，安全都是一个非常重要的问题。我们可以将 “<strong>安全左移（Shift Left Security）</strong>”，这样就可以减少生产环境中的安全风险；对于扫描工具 Trivy 来说，它对于保证镜像的安全性非常有用，它不仅可以扫描镜像，还可以扫描 Git 仓库，文件系统等。</p><p>最后，非常感谢同事张思楚、王亦晨和邢砚敏等人的大力支持和指导，在他们热心帮助和辛苦付出之下才有了这篇文章。</p></div><div class=references><h2>参考</h2><ol><li>SoneQube: <a href=https://www.sonarqube.org/ target=_blank rel="noopener noreferrer">https://www.sonarqube.org/</a></li><li>Trivy: <a href=https://github.com/aquasecurity/trivy target=_blank rel="noopener noreferrer">https://github.com/aquasecurity/trivy</a></li><li>claire: <a href=https://github.com/quay/clair target=_blank rel="noopener noreferrer">https://github.com/quay/clair</a></li><li>Anchore Engine: <a href=https://github.com/anchore/anchore-engine target=_blank rel="noopener noreferrer">https://github.com/anchore/anchore-engine</a></li><li>Quay: <a href=https://github.com/quay/quay target=_blank rel="noopener noreferrer">https://github.com/quay/quay</a></li><li>Docker hub: <a href=https://hub.docker.com/ target=_blank rel="noopener noreferrer">https://hub.docker.com/</a></li><li>GCR: <a href=https://cloud.google.com/container-registry target=_blank rel="noopener noreferrer">https://cloud.google.com/container-registry</a></li><li>NVD: <a href=https://nvd.nist.gov target=_blank rel="noopener noreferrer">https://nvd.nist.gov</a></li><li>Nignx:1.18: <a href=https://hub.docker.com/_/nginx target=_blank rel="noopener noreferrer">https://hub.docker.com/_/nginx</a></li><li>https://github.com/guzhongren/Buildkite-Dashboard/commit/90182b9b3770aeb28a6e566208334dd0c6f8f725#annotation_843974303: <a href=https://github.com/guzhongren/Buildkite-Dashboard/commit/90182b9b3770aeb28a6e566208334dd0c6f8f725#annotation_843974303 target=_blank rel="noopener noreferrer">https://github.com/guzhongren/Buildkite-Dashboard/commit/90182b9b3770aeb28a6e566208334dd0c6f8f725#annotation_843974303</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-08-04&nbsp;<a class=git-hash href=https://github.com/guzhongren/guzhongren.github.io/commit/b7c8b45b49b01fea96cac51c333df41169625f46 target=_blank title="commit by guzhongren(guzhongren@live.cn) b7c8b45b49b01fea96cac51c333df41169625f46: docs: remove ref">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>b7c8b45</a></span></div><div class=post-info-license><span><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/80x15.png></a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2021/09/container-image-scanner-trivy/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=x data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy" data-via=guzhongren data-hashtags=Trivy,DevOps,Pipeline><i class="fab fa-x-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Threads" data-sharer=threads data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy"><i class="fab fa-threads fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-hashtag=Trivy><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy" data-image=https://cdn.jsdelivr.net/gh/guzhongren/picx-images-hosting@master/20210819/Group%2052.5gp1z5ybbps0.png><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Diaspora" data-sharer=diaspora data-url=https://guzhongren.github.io/2021/09/container-image-scanner-trivy/ data-title="Container Image Scanner - Trivy" data-description="Container Image Scanner"><i class="fab fa-diaspora fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=https%3a%2f%2fguzhongren.github.io%2f2021%2f09%2fcontainer-image-scanner-trivy%2f&amp;text=Container%20Image%20Scanner%20-%20Trivy" target=_blank title="分享到 Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/trivy/>Trivy</a>,&nbsp;<a href=/tags/devops/>DevOps</a>,&nbsp;<a href=/tags/pipeline/>Pipeline</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2021/08/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BC%9A%E8%AE%AE/ class=prev rel=prev title=敏捷开发中有哪些会议？><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>敏捷开发中有哪些会议？</a>
<a href=/2021/10/container-image-scanner-trivy/ class=next rel=next title="Container Image Scanner - Trivy">Container Image Scanner - Trivy<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>友情链接:<div style=display:flex;justify-content:center;align-items:center><a style="display:flex;justify-content:center;align-items:center;margin:0 1rem" href=https://yihaimen.github.io><span style=display:flex;justify-content:center;align-items:center><img style=height:24px src=https://yihaimen.github.io/images/avatar.png><span>易海门的博客</span></span></a><a style="display:flex;justify-content:center;align-items:center;margin:0 1rem" href=https://bytewars.cc><span style=display:flex;justify-content:center;align-items:center><img style=height:24px src=https://bytewars.github.io/images/avatar.png><span>ByteWars社区</span></span></a></div></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.140.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=guzhongren@live.cn target=_blank>谷中仁</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/algoliasearch@5.20.2/dist/lite/builds/browser.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script>window.config={comment:{utterances:{darkTheme:"github-dark",issueTerm:"title",label:"utterances",lightTheme:"github-light",repo:"guzhongren/guzhongren.github.io"}},search:{algoliaAppID:"8FBSWQTAD1",algoliaIndex:"index.zh-cn",algoliaSearchKey:"f8e94db6f14a6320dcdcb4db3f7256aa",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"algolia"},twemoji:!0}</script><script src=/js/theme.min.js></script></body></html>